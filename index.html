<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Völkerwanderung: The East Roman Dilemma</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        /* API KEY TRESOR */
        function getApiKey() {
            let key = localStorage.getItem('gemini_api_key');
            if (!key) {
                setTimeout(() => document.getElementById('key-modal').classList.remove('hidden'), 1000);
                return null;
            }
            return key;
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                document.getElementById('key-modal').classList.add('hidden');
                alert("Schlüssel gespeichert! Analyse aktiv.");
                location.reload(); 
            }
        }

        function clearApiKey() {
            localStorage.removeItem('gemini_api_key');
            alert("Schlüssel entfernt.");
            location.reload();
        }

        /* ARTEFAKTE (SVG) */
        const artifacts = {
            westgoten: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M200 50 C230 50 250 80 250 100 L280 150 L200 250 L120 150 L150 100 C150 80 170 50 200 50' fill='%23b91c1c' stroke='%23b45309' stroke-width='5'/%3E%3Ccircle cx='200' cy='90' r='15' fill='%2378350f' stroke='%23fcd34d' stroke-width='3'/%3E%3C/svg%3E`,
            vandalen: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Ccircle cx='200' cy='150' r='100' fill='%23cbd5e1' stroke='%2394a3b8' stroke-width='4'/%3E%3Ctext x='200' y='280' text-anchor='middle' font-family='serif' font-weight='bold' fill='%2364748b' font-size='18' letter-spacing='2'%3ED N REX GELIMER%3C/text%3E%3C/svg%3E`,
            hunnen: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M200 60 C240 60 260 100 260 140 L240 260 L160 260 L140 140 C140 100 160 60 200 60' fill='%2365a30d' stroke='%23fcd34d' stroke-width='4'/%3E%3C/svg%3E`,
            langobarden: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Crect x='180' y='50' width='40' height='200' fill='%23fcd34d' stroke='%23b45309' stroke-width='2'/%3E%3Crect x='100' y='110' width='200' height='40' fill='%23fcd34d' stroke='%23b45309' stroke-width='2'/%3E%3C/svg%3E`,
            franken: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M200 80 C220 80 240 100 240 130 C240 160 200 220 200 220 C200 220 160 160 160 130 C160 100 180 80 200 80' fill='%23fbbf24' stroke='%23b45309' stroke-width='2'/%3E%3Cpath d='M160 130 L120 110' fill='%23ef4444'/%3E%3Cpath d='M240 130 L280 110' fill='%23ef4444'/%3E%3C/svg%3E`,
            ostgoten: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M200 40 L240 80 L220 180 L200 260 L180 180 L160 80 Z' fill='%23be123c' stroke='%23fbbf24' stroke-width='4'/%3E%3C/svg%3E`,
            rom: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cdefs%3E%3CradialGradient id='shield' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' style='stop-color:%237e22ce;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23581c87;stop-opacity:1' /%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='200' cy='150' r='110' fill='url(%23shield)' stroke='%23fbbf24' stroke-width='8'/%3E%3Cpath d='M200 60 L200 240 M150 100 L250 200 M250 100 L150 200' stroke='%23fbbf24' stroke-width='12' stroke-linecap='round'/%3E%3Cpath d='M200 60 C220 40 240 60 230 80' stroke='%23fbbf24' stroke-width='8' fill='none'/%3E%3C/svg%3E`,
            pest: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M100 150 Q150 50 250 150 T350 150' fill='none' stroke='%2310b981' stroke-width='10'/%3E%3Ccircle cx='200' cy='120' r='40' fill='%23064e3b'/%3E%3Crect x='180' y='180' width='40' height='60' fill='%23064e3b'/%3E%3Cpath d='M180 240 L220 280 M220 240 L180 280' stroke='%2310b981' stroke-width='5'/%3E%3Ctext x='200' y='280' text-anchor='middle' fill='%2310b981' font-family='sans-serif' font-weight='bold' font-size='24' letter-spacing='2'%3EYERSINIA PESTIS%3C/text%3E%3C/svg%3E`,
            fabrica: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Crect x='50' y='50' width='300' height='200' fill='%23e5e5e5' stroke='%23333' stroke-width='10'/%3E%3Cpath d='M100 200 L300 200 L280 150 L120 150 Z' fill='%23333'/%3E%3Ccircle cx='200' cy='120' r='30' fill='%23b91c1c'/%3E%3C/svg%3E`,
            coin: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Ccircle cx='200' cy='150' r='100' fill='%23fbbf24' stroke='%23b45309' stroke-width='5'/%3E%3Ctext x='200' y='160' text-anchor='middle' font-family='serif' font-weight='bold' fill='%2392400e' font-size='40'%3ESOLIDUS%3C/text%3E%3C/svg%3E`,
            grain: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M200 50 Q230 150 200 250 Q170 150 200 50' fill='%23fbbf24' stroke='%23d97706' stroke-width='5'/%3E%3Cpath d='M200 50 L180 100 M200 80 L220 130 M200 120 L180 170 M200 160 L220 210' stroke='%23d97706' stroke-width='3'/%3E%3C/svg%3E`
        };

        // Robuste SVG-Pfeile für die Schlacht-Animation
        const battleArrowSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor"><path d="M238.63,114.34l-80-80a8,8,0,0,0-11.32,0L128,53.66V24A16,16,0,0,0,112,8H32A16,16,0,0,0,16,24V168a16,16,0,0,0,16,16h80a16,16,0,0,0,16-16V138.34l19.31,19.32a8,8,0,0,0,11.32,0l80-80A8,8,0,0,0,238.63,114.34ZM112,168H32V24h80V80a8,8,0,0,0,8,8h56V64.94l47.06,47L176,159.06V112a8,8,0,0,0-8-8H120A8,8,0,0,0,112,112Z"/></svg>`;

        const fallbackImage = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300' fill='%23f5f5f4'%3E%3Crect width='400' height='300' fill='%23e5e5e5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' fill='%23999'%3EBild nicht verfügbar%3C/text%3E%3C/svg%3E";
        function handleImageError(img) { img.onerror = null; img.src = fallbackImage; img.parentElement.classList.remove('hidden'); }

        const localImages = {
            westgoten: './img/westgoten.jpg', vandalen: './img/vandalen.jpg',
            hunnen: './img/hunnen.jpg', langobarden: './img/langobarden.jpg',
            franken: './img/franken.jpg', ostgoten: './img/ostgoten.jpg',
            rom: './img/rom_armee.jpg', pest: './img/pest.jpg'
        };

        function formatText(text) {
            if (!text) return '';
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }
    </script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100vw; background: #e5e5e5; z-index: 1; }
        .ui-layer { position: absolute; z-index: 3000; pointer-events: none; }
        .ui-element { pointer-events: auto; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #d97706; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); cursor: pointer; margin-top: -10px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #d6d3d1; border-radius: 2px; }

        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(2.0); opacity: 0; } }
        @keyframes alert-pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(255, 255, 255, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }

        .pulse-icon { position: relative; }
        .pulse-icon:after { content: ''; position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 50%; background: inherit; animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; z-index: -1; }
        .roman-pulse:after { border: 2px solid #7e22ce; animation: pulse-ring 2s infinite; }
        .climate-pulse:after { border: 2px solid #06b6d4; animation: pulse-ring 2.5s infinite; background: rgba(6,182,212,0.1); }
        .plague-pulse:after { border: 2px solid #10b981; animation: pulse-ring 1s infinite; background: rgba(16, 185, 129, 0.2); }
        
        /* DYNAMISCHE ALERT-BUTTONS (HIGH READABILITY) */
        @keyframes slide-in-down { 0% { transform: translate(-50%, -20px); opacity: 0; } 100% { transform: translate(-50%, 0); opacity: 1; } }
        
        .alert-card {
            background: rgba(255, 255, 255, 0.98); /* High opacity */
            backdrop-filter: blur(10px);
            border: 1px solid #e5e5e5;
            border-left-width: 5px;
            box-shadow: 0 12px 28px -6px rgba(0, 0, 0, 0.15), 0 8px 12px -4px rgba(0, 0, 0, 0.1);
            animation: slide-in-down 0.6s ease-out;
            color: #1c1917;
        }
        
        .border-battle { border-left-color: #dc2626; }
        .border-treaty { border-left-color: #7e22ce; }
        .border-move { border-left-color: #4f46e5; }
        .border-nature { border-left-color: #0891b2; }
        .border-plague { border-left-color: #059669; }
        .border-law { border-left-color: #ca8a04; }
        
        .leaflet-tooltip.custom-label { background-color: rgba(255, 255, 255, 0.95); border: 1px solid #999; color: #333; font-family: serif; font-weight: bold; font-size: 12px; padding: 2px 6px; border-radius: 2px; }
        .leaflet-tooltip.region-label { background: transparent; border: none; box-shadow: none; font-family: 'Times New Roman', serif; font-weight: bold; color: #78716c; text-transform: uppercase; letter-spacing: 0.15em; font-size: 14px; opacity: 0.7; pointer-events: none; text-shadow: 1px 1px 0px rgba(255,255,255,0.5); }
        .leaflet-tooltip-left:before, .leaflet-tooltip-right:before { display: none; }
        .leaflet-marker-icon, .leaflet-tooltip { transition: opacity 0.5s ease-in-out; }

        /* Logistik Animationen */
        @keyframes grain-flow { to { stroke-dashoffset: -20; } }
        .grain-route-line { animation: grain-flow 1s linear infinite; }
        
        @keyframes gold-flow { to { stroke-dashoffset: -20; } }
        .gold-route-line { animation: gold-flow 2s linear infinite; }

        @keyframes iron-flow { to { stroke-dashoffset: -20; } }
        .iron-route-line { animation: iron-flow 1.5s linear infinite; }

        /* Roms Hunger-Pulsieren */
        @keyframes famine-pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.3); opacity: 0.4; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        .famine-marker {
            background: radial-gradient(circle, rgba(220, 38, 38, 0.8) 0%, rgba(220, 38, 38, 0) 70%);
            border-radius: 50%;
            animation: famine-pulse 2s infinite;
        }

        /* Kornkammer Animation (Weizen im Wind) */
        @keyframes wheat-sway {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
        .wheat-icon-inner {
            animation: wheat-sway 3s ease-in-out infinite;
            transform-origin: bottom center;
        }

        /* SCHLACHT ANIMATIONEN (Cinematic - SVG Version) */
        @keyframes arrow-slide-west { 0% { transform: translateX(-60px) scale(0.5); opacity: 0; } 80% { transform: translateX(-5px) scale(1.1); opacity: 1; } 100% { transform: translateX(0) scale(1); opacity: 1; } }
        @keyframes arrow-slide-east { 0% { transform: translateX(60px) scale(0.5) rotate(180deg); opacity: 0; } 80% { transform: translateX(5px) scale(1.1) rotate(180deg); opacity: 1; } 100% { transform: translateX(0) scale(1) rotate(180deg); opacity: 1; } }
        @keyframes arrow-slide-north { 0% { transform: translateY(-60px) scale(0.5) rotate(90deg); opacity: 0; } 80% { transform: translateY(-5px) scale(1.1) rotate(90deg); opacity: 1; } 100% { transform: translateY(0) scale(1) rotate(90deg); opacity: 1; } }
        @keyframes arrow-slide-south { 0% { transform: translateY(60px) scale(0.5) rotate(-90deg); opacity: 0; } 80% { transform: translateY(5px) scale(1.1) rotate(-90deg); opacity: 1; } 100% { transform: translateY(0) scale(1) rotate(-90deg); opacity: 1; } }

        @keyframes shockwave { 
            0% { transform: scale(0.1); opacity: 0.8; border-width: 6px; } 
            100% { transform: scale(5.0); opacity: 0; border-width: 0px; } 
        }

        .battle-svg-container { width: 64px; height: 64px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); display: flex; align-items: center; justify-content: center; }
        .arrow-anim-west { animation: arrow-slide-west 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .arrow-anim-east { animation: arrow-slide-east 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .arrow-anim-north { animation: arrow-slide-north 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .arrow-anim-south { animation: arrow-slide-south 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        
        .shockwave-effect {
            position: absolute; width: 20px; height: 20px; top: 50%; left: 50%; margin-top:-10px; margin-left:-10px;
            border-radius: 50%; border: 4px solid #dc2626;
            background: rgba(220, 38, 38, 0.1);
            animation: shockwave 3s infinite ease-out;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-stone-100">

    <div id="map"></div>

    <div class="ui-layer top-0 left-0 right-0 p-4 flex flex-col md:flex-row justify-between items-start gap-3 pointer-events-none">
        <div class="ui-element inline-block bg-white/95 backdrop-blur shadow-lg rounded-lg px-4 py-3 border-l-4 border-amber-600 pointer-events-auto">
            <h1 class="text-lg font-serif font-bold text-stone-800 leading-none flex items-center gap-2">
                <i class="ph-fill ph-globe-hemisphere-east text-amber-600"></i> Völkerwanderung
            </h1>
            <p class="text-xs text-stone-500 font-mono mt-1">ca. 375 – 568 n. Chr.</p>
        </div>

        <div id="narrative-alert" class="hidden ui-element mx-auto md:absolute md:left-1/2 md:-translate-x-1/2 md:top-6 z-[5000]">
            <button id="alert-btn" onclick="askGeminiEvent()" class="alert-card px-6 py-4 rounded-r-lg flex items-center gap-4 cursor-pointer hover:scale-105 transition-transform min-w-[340px] max-w-lg justify-between group">
                <div class="flex items-center gap-4">
                    <div class="p-2 bg-stone-100/80 rounded-full shrink-0">
                        <i id="alert-icon" class="ph-fill text-3xl text-stone-700"></i>
                    </div>
                    <div class="text-left leading-snug">
                        <span id="alert-type" class="block text-xs font-bold text-stone-500 uppercase tracking-widest font-sans mb-1"></span>
                        <span id="alert-title" class="block text-xl font-serif font-bold text-stone-900 tracking-wide"></span>
                    </div>
                </div>
                <div class="text-stone-400 group-hover:text-purple-600 transition-colors ml-4"><i class="ph-bold ph-caret-right text-2xl"></i></div>
            </button>
        </div>

        <div class="ui-element flex gap-2 pointer-events-auto self-end md:self-auto">
            <button onclick="clearApiKey()" class="bg-white/90 hover:bg-white text-stone-500 border border-stone-200 px-2 py-2 rounded-lg shadow-sm flex items-center gap-2 text-xs" title="API Key löschen">
                <i class="ph-bold ph-key"></i>
            </button>
            <button onclick="askGeminiContext()" class="md:hidden bg-white text-purple-700 border border-purple-200 px-3 py-2 rounded-lg shadow-lg flex items-center gap-2 text-sm font-bold">
                <i class="ph-fill ph-sparkle"></i> Zeitgeist
            </button>
        </div>
    </div>

    <div id="key-modal" class="hidden fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 ui-element">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 border border-stone-200">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="ph-fill ph-key text-purple-600 text-2xl"></i>
                </div>
                <h2 class="font-serif font-bold text-xl text-stone-800">Setup: KI-Verbindung</h2>
                <p class="text-sm text-stone-500 mt-2">Geben Sie Ihren neuen API-Key ein. Er wird nur lokal gespeichert.</p>
            </div>
            <input type="password" id="api-key-input" placeholder="Key einfügen (AIzaSy...)" class="w-full p-3 border border-stone-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-500 focus:outline-none font-mono text-sm">
            <button onclick="saveApiKey()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-colors">Speichern & Starten</button>
        </div>
    </div>

    <div id="info-box" class="hidden ui-layer top-20 left-4 right-4 md:left-auto md:right-4 md:w-[400px] max-h-[75vh] flex flex-col rounded-xl shadow-2xl z-[4000] bg-white border border-stone-300 pointer-events-auto">
        <div id="info-artifact-container" class="relative w-full h-48 bg-stone-100 shrink-0 border-b border-stone-200">
            <img id="artifact-img" src="" alt="Artefakt" class="w-full h-full object-contain p-4">
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-white via-white/80 to-transparent p-2 pt-8">
                 <div class="flex items-center gap-2 text-amber-700 px-2">
                    <i class="ph-fill ph-bank"></i>
                    <span class="text-[10px] font-bold uppercase tracking-wider">Historisches Objekt</span>
                </div>
            </div>
        </div>
        <div class="p-5 overflow-y-auto">
            <div class="flex justify-between items-start mb-2">
                <h2 id="info-title" class="font-serif font-bold text-2xl text-stone-900"></h2>
                <button onclick="closeInfo()" class="p-1 hover:bg-stone-100 rounded-full text-stone-500 hover:text-red-600"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <h3 id="artifact-title" class="text-sm font-bold text-stone-800 mb-2"></h3>
            <p id="artifact-desc" class="text-xs text-stone-500 italic border-b border-stone-200 pb-3 mb-3 leading-relaxed"></p>
            <div id="info-quote" class="hidden mb-4 pl-3 border-l-4 border-stone-300 italic text-stone-800 font-serif text-sm bg-stone-50 p-3 rounded-r shadow-sm"></div>
            <div id="info-content" class="text-base text-stone-800 leading-relaxed mb-2"></div>
            <div id="tribe-ai-response" class="hidden mt-4 p-3 bg-purple-50 rounded-lg border border-purple-100 text-sm text-stone-800 leading-relaxed"></div>
        </div>
        <div id="tribe-ai-section" class="p-3 border-t border-stone-100 bg-stone-50 rounded-b-xl">
            <button onclick="askGeminiTribe()" id="tribe-ai-btn" class="w-full bg-white hover:bg-purple-50 border border-purple-200 text-purple-900 px-4 py-3 rounded-lg flex items-center justify-center gap-2 text-xs font-bold transition-all shadow-sm hover:shadow cursor-pointer">
                <i class="ph-fill ph-sparkle text-purple-600 text-lg"></i>
                <span id="tribe-ai-text">KI-Analyse: Situation im Jahr <span id="tribe-ai-year">...</span></span>
            </button>
        </div>
    </div>

    <div id="ai-modal" class="hidden fixed inset-0 z-[5000] bg-stone-900/60 backdrop-blur-sm flex items-center justify-center p-4 ui-element">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col h-[80vh] overflow-hidden border border-stone-300">
            <div class="bg-stone-100 p-4 border-b border-stone-200 flex justify-between items-center">
                <div>
                    <h3 class="font-serif font-bold text-lg text-stone-800 flex items-center gap-2">
                        <i class="ph-fill ph-chat-circle-text text-purple-600"></i> 
                        Historischer Diskurs
                    </h3>
                    <p class="text-xs text-stone-500 font-mono" id="ai-context-label">Kontext: Jahr <span id="ai-modal-year"></span></p>
                </div>
                <button onclick="closeAiModal()" class="hover:bg-stone-200 rounded-full p-2 transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            
            <div id="ai-chat-history" class="flex-1 p-6 overflow-y-auto bg-stone-50 flex flex-col gap-4">
                </div>

            <div class="p-4 bg-white border-t border-stone-200">
                <div class="flex gap-2">
                    <input type="text" id="ai-user-input" placeholder="Stellen Sie eine Nachfrage (z.B. 'Welche Folgen hatte das für die Plebs?')" 
                           class="flex-1 border border-stone-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:outline-none font-serif text-sm"
                           onkeypress="if(event.key === 'Enter') sendFollowUp()">
                    <button onclick="sendFollowUp()" class="bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center">
                        <i class="ph-bold ph-paper-plane-right text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="ui-layer bottom-0 left-0 right-0">
        <div class="ui-element bg-white border-t border-stone-200 shadow-lg p-4 pb-8 md:pb-6">
            <div class="max-w-5xl mx-auto w-full">
                
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-4">
                        <button id="play-btn" onclick="togglePlay()" class="w-14 h-14 bg-stone-800 hover:bg-stone-700 text-white rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                            <i id="play-icon" class="ph-fill ph-play text-2xl ml-1"></i>
                        </button>
                        
                        <div>
                            <div class="text-[10px] uppercase tracking-widest text-stone-500 font-bold">Jahr</div>
                            <div class="text-4xl font-serif font-bold text-stone-800 tabular-nums" id="year-display">375</div>
                        </div>

                        <div class="hidden md:flex items-center ml-4 bg-stone-100 rounded-lg p-1 border border-stone-200">
                            <button onclick="setSpeed('slow')" id="speed-slow" class="px-3 py-1 text-xs font-bold rounded-md transition-colors bg-white shadow-sm text-black">Langsam</button>
                            <button onclick="setSpeed('medium')" id="speed-medium" class="px-3 py-1 text-xs font-bold rounded-md transition-colors text-stone-600 hover:bg-white">Mittel</button>
                            <button onclick="setSpeed('fast')" id="speed-fast" class="px-3 py-1 text-xs font-bold rounded-md transition-colors text-stone-600 hover:bg-white">Schnell</button>
                        </div>
                    </div>

                    <button onclick="askGeminiContext()" class="hidden md:flex bg-purple-50 border border-purple-200 text-purple-900 hover:bg-purple-100 px-4 py-2 rounded-full shadow-sm items-center gap-2 text-xs font-bold transition-all active:scale-95">
                        <i class="ph-fill ph-sparkle text-purple-600 text-lg"></i> 
                        <div class="flex flex-col items-start leading-tight"><span>Historische Lage</span><span class="text-[10px] opacity-70">Analysiere <span id="ai-btn-year-ref">375</span></span></div>
                    </button>
                </div>

                <div class="hidden md:flex gap-3 text-[10px] font-medium text-stone-500 flex-wrap mb-2">
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-red-600 rounded-full"></div>Westgoten</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-blue-600 rounded-full"></div>Vandalen</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-green-600 rounded-full"></div>Hunnen</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-orange-600 rounded-full"></div>Langobarden</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-purple-600 rounded-full"></div>Franken</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-rose-800 rounded-full"></div>Ostgoten</div>
                    <div class="flex items-center gap-1 border-l pl-2 border-stone-300"><div class="w-2 h-2 bg-purple-700 rounded-full"></div>Rom. Armee</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-emerald-500 rounded-full"></div>Pest</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-cyan-500 rounded-full"></div>Klima</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-amber-600 rounded-full"></div>Annona (Korn)</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-yellow-400 rounded-full"></div>Aurum (Gold)</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-slate-500 rounded-full"></div>Ferrum (Eisen)</div>
                </div>

                <div class="relative px-2">
                    <input type="range" id="year-slider" min="375" max="568" value="375" step="0.1" oninput="updateYear(this.value)" onchange="updateYear(this.value)">
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- CONFIG & SETUP ---
        const apiKey = ""; 
        let currentTribeForAI = null;
        let map;
        const layers = {};
        const eventMarkers = {};
        const cityMarkers = {};
        let climateLayer = null, plagueLayer = null, droughtLayer = null;
        
        let isPlaying = false;
        let animationId = null;
        let lastFrameTime = 0;
        
        // MASTER-VARIABLE FÜR ZEIT
        let currentYear = 375.0; 
        
        let activeAlertEvent = null;
        let chatHistory = []; 

        // LOGISTIK GLOBALS
        let grainRouteLayer = null;
        let romeStatusIcon = null;
        let granaryMarkers = []; 
        
        // GOLD & EISEN GLOBALS
        let goldRouteLayer = null;
        let goldStatusIcon = null;
        let mineMarker = null;
        let ironRoutes = [];
        let fabricaeMarkers = [];
        let kingdomLayers = {};

        // BATTLE VISUALS
        let activeBattleAnimations = {};
        
        const grainPathCoords = [
            [36.8, 10.1], // Karthago
            [37.5, 11.0], 
            [39.0, 11.5], // Tyrrhenisches Meer
            [40.5, 12.0],
            [41.8, 12.2]  // Ostia/Rom
        ];

        const goldPathCoords = [
            [42.46, -6.8], // Las Medulas
            [41.6, -4.7],  // Valladolid
            [41.1, 1.2],   // Tarraco
            [42.0, 6.0],   // Seeweg
            [44.4, 12.2]   // Ravenna
        ];

        // EISEN-ROUTEN (Massiv erweitert für Limes-Versorgung)
        const ironPaths = [
            // Trier -> Verteiler Rhein (Nord & Süd)
            { path: [[49.75, 6.63], [50.35, 7.6], [50.93, 6.96], [51.66, 6.45]], start: 0, end: 413, id: 'trier-nord' }, // Nach Köln/Xanten
            { path: [[49.75, 6.63], [49.99, 8.24], [48.58, 7.75]], start: 0, end: 413, id: 'trier-sued' }, // Nach Mainz/Straßburg
            // Sirmium -> Donau
            { path: [[44.9, 19.6], [45.2, 20.0], [44.8, 20.4], [45.0, 21.0]], start: 0, end: 441, id: 'sirmium' } 
        ];

        const kingdoms = {
            vandalen: { name: "Regnum Vandalorum", color: "#2563eb", center: [36.8, 10.1], radius: 300000, start: 439, end: 533 },
            westgoten: { name: "Regnum Visigothorum", color: "#dc2626", center: [43.6, 1.4], radius: 250000, start: 418, end: 507 },
            ostgoten: { name: "Regnum Ostrogothorum", color: "#9f1239", center: [44.4, 12.2], radius: 280000, start: 493, end: 553 },
            syagrius: { name: "Reich des Syagrius", color: "#7e22ce", center: [49.3, 3.3], radius: 150000, start: 461, end: 486 }
        };
        
        // Speed Controls
        const speedConfig = { 
            slow: 0.15,   
            medium: 0.5,  
            fast: 1.2     
        };
        let yearStep = speedConfig.slow; 

        // --- GEO-DATEN ---
        const limesPath = [ [52.2, 4.4], [52.0, 5.1], [51.2, 6.8], [50.9, 7.0], [50.0, 8.2], [49.0, 8.4], [49.0, 10.9], [48.9, 12.0], [48.4, 13.4], [48.3, 14.3], [48.1, 16.4], [47.8, 17.6], [47.5, 19.0], [44.8, 20.4], [44.6, 22.6], [45.2, 29.6] ];
        const historicalRegions = [ { c: [46.5, 2.0], t: "GALLIA", s: 16 }, { c: [40.0, -4.0], t: "HISPANIA", s: 16 }, { c: [42.5, 12.5], t: "ITALIA", s: 16 }, { c: [45.0, 17.0], t: "PANNONIA", s: 14 }, { c: [43.0, 22.0], t: "ILLYRICUM", s: 14 }, { c: [42.0, 25.0], t: "THRACIA", s: 14 }, { c: [35.0, 2.0], t: "AFRICA", s: 16 }, { c: [51.0, 10.0], t: "GERMANIA", s: 16, color: "#a8a29e" }, { c: [48.0, 30.0], t: "SCYTHIA", s: 14, color: "#a8a29e" } ];
        const dynamicCities = [ { c: [41.9, 12.5], t: "Rom", type: 'capital', start: 0, end: 600 }, { c: [41.0, 28.9], t: "Konstantinopel", type: 'capital', start: 330, end: 600 }, { c: [36.8, 10.1], t: "Karthago", type: 'city', start: 0, end: 600 }, { c: [44.4, 12.2], t: "Ravenna", type: 'capital', start: 402, end: 600 }, { c: [43.6, 1.4], t: "Tolosa", type: 'barbarian', start: 418, end: 507 }, { c: [39.8, -4.0], t: "Toledo", type: 'barbarian', start: 507, end: 600 }, { c: [41.5, 13.8], t: "Monte Cassino", type: 'monastery', start: 529, end: 600 } ];
        
        const routes = {
            westgoten: { name: "Westgoten", color: "#dc2626", desc: "Foederati, dann Tolosanisches Reich.", path: [[45.5, 25.0, 375], [41.6, 26.5, 378], [40.6, 22.9, 395], [41.9, 12.5, 410], [43.6, 1.4, 418], [41.6, -4.7, 470], [39.8, -4.0, 507]], artifact: { img: localImages.westgoten, fallback: artifacts.westgoten, title: "Adlerfibel", text: "Meisterwerk der Cloisonné-Technik." } },
            vandalen: { name: "Vandalen", color: "#2563eb", desc: "Zug nach Karthago, Seemacht.", path: [[51.0, 17.0, 375], [50.0, 8.2, 405], [49.9, 8.2, 406], [44.8, -0.5, 409], [37.3, -5.9, 415], [35.9, -5.6, 429], [36.8, 10.1, 439], [41.9, 12.5, 455], [36.8, 10.1, 460]], artifact: { img: localImages.vandalen, fallback: artifacts.vandalen, title: "Siliqua des Gelimer", text: "Vandalische Silbermünze." } },
            hunnen: { name: "Hunnen", color: "#16a34a", desc: "Reiternomaden, 'Geißel Gottes'.", path: [[48.0, 43.0, 375], [47.0, 30.0, 390], [47.5, 19.0, 405], [49.0, 4.0, 451], [45.4, 10.9, 452], [47.5, 19.0, 453]], artifact: { img: localImages.hunnen, fallback: artifacts.hunnen, title: "Zikadenfibel", text: "Symbol der Wiedergeburt." } },
            langobarden: { name: "Langobarden", color: "#d97706", desc: "Späte Einwanderung nach Italien.", path: [[53.5, 10.5, 375], [53.5, 10.5, 400], [48.5, 16.5, 489], [47.5, 19.0, 526], [46.0, 13.0, 568], [45.4, 9.1, 572]], artifact: { img: localImages.langobarden, fallback: artifacts.langobarden, title: "Goldblattkreuz", text: "Langobardische Grabbeigabe." } },
            franken: { name: "Franken", color: "#9333ea", desc: "Expansion vom Rhein nach Gallien.", path: [[51.5, 5.0, 375], [51.0, 4.5, 430], [50.0, 3.5, 451], [49.4, 3.3, 486], [48.8, 2.3, 500], [46.5, 0.5, 507], [48.8, 2.3, 511]], artifact: { img: localImages.franken, fallback: artifacts.franken, title: "Goldbiene", text: "Aus dem Grab Childerichs." } },
            ostgoten: { name: "Ostgoten", color: "#9f1239", desc: "Zug nach Italien (489).", path: [[47.0, 32.0, 375], [46.5, 29.0, 400], [47.5, 19.0, 454], [46.0, 14.5, 488], [45.4, 11.0, 489], [44.4, 12.2, 493], [44.4, 12.2, 526]], artifact: { img: localImages.ostgoten, fallback: artifacts.ostgoten, title: "Adlerfibel", text: "Ostgotische Goldschmiedekunst." } },
            stilicho: { name: "Legionen (Stilicho)", color: "#7e22ce", type: "army", desc: "401: Stilicho zieht Truppen von der Rheingrenze ab.", path: [[50.0, 8.2, 401], [47.5, 7.5, 401.5], [45.4, 9.2, 402]], artifact: { img: localImages.rom, fallback: artifacts.rom, title: "Schildzeichen (Chi-Rho)", text: "Das Christusmonogramm auf den Schilden." } },
            aetius: { name: "Heer des Aetius", color: "#7e22ce", type: "army", desc: "451: Aetius mobilisiert gegen Attila.", path: [[41.9, 12.5, 450], [45.0, 5.0, 450.5], [49.0, 4.0, 451]], artifact: { img: localImages.rom, fallback: artifacts.rom, title: "Schildzeichen (Chi-Rho)", text: "Symbol des christlichen Imperiums." } },
            belisarius: { name: "Flotte (Belisar)", color: "#7e22ce", type: "army", desc: "533: Oströmische Rückeroberung.", path: [[41.0, 28.9, 533], [37.0, 15.0, 533.4], [36.8, 10.1, 533.8], [37.5, 14.0, 535], [41.9, 12.5, 536], [44.4, 12.2, 540]], artifact: { img: localImages.rom, fallback: artifacts.rom, title: "Schildzeichen (Chi-Rho)", text: "Symbol der Restauratio Imperii." } },
            pest: { name: "Die Pest", color: "#10b981", type: "plague", desc: "541-545: Yersinia pestis breitet sich aus.", path: [[31.0, 32.5, 541], [31.2, 29.9, 541.5], [41.0, 28.9, 542], [38.0, 23.0, 542.5], [37.5, 15.0, 543], [41.9, 12.5, 543.5], [43.3, 5.4, 544], [48.0, 2.0, 545]], artifact: { img: localImages.pest, fallback: artifacts.pest, title: "Yersinia pestis", text: "Der Erreger der Beulenpest." } }
        };
        
        const historicalEvents = [ 
            { year: 375, lat: 48.0, lng: 45.0, title: "Megadürre", type: "climate", icon: "ph-sun-dim", duration: 25, desc: "Jahrzehntelange Trockenheit treibt die Hunnen nach Westen.", quote: "Die Steppe verdorrte." },
            { 
                year: 378, lat: 41.67, lng: 26.56, title: "Schlacht von Adrianopel", type: "battle", desc: "Goten besiegen Valens.", quote: "Ein Gemetzel wie bei Cannae.",
                vectors: [{dir: 'west', color: '#7e22ce'}, {dir: 'east', color: '#b91c1c'}] 
            }, 
            { year: 401, lat: 45.4, lng: 9.2, title: "Alarichs Einfall", type: "move", desc: "Goten fallen in Italien ein.", quote: "Die Mauern erzittern." },
            { year: 406, lat: 49.9, lng: 8.2, title: "Rheinübergang", type: "move", desc: "Vandalen & Sueben brechen durch.", quote: "Ganz Gallien rauchte." },
            { year: 409, lat: 42.0, lng: -6.0, title: "Verlust Spaniens", type: "crisis", icon: "ph-coins", desc: "Sueben besetzen die Goldminen. Der Sold für die Legionen versiegt.", quote: "Der Staat verliert sein Gold." },
            { year: 410, lat: 41.9, lng: 12.5, title: "Plünderung Roms", type: "battle", desc: "Alarich in Rom.", quote: "Die Stadt ist erobert." }, 
            { year: 421, lat: 36.0, lng: 38.0, title: "Perserkrieg (Bahram V.)", type: "crisis", icon: "ph-sword", desc: "Ostrom muss Truppen an die Euphrat-Grenze werfen.", quote: "Der Osten ist gebunden." },
            { year: 429, lat: 35.9, lng: -5.6, title: "Zug nach Afrika", type: "move", desc: "Vandalen setzen über.", quote: "Das Brot geht aus." },
            { year: 438, lat: 41.0, lng: 28.9, title: "Codex Theodosianus", type: "law", icon: "ph-scales", desc: "Kaiser Theodosius II. Gesetzessammlung.", quote: "Ordnung in das Chaos der Gesetze bringen.", aiPrompt: "Analysiere die verfassungsrechtliche Bedeutung des Codex Theodosianus." },
            { year: 441, lat: 44.9, lng: 19.6, title: "Fall von Sirmium", type: "crisis", icon: "ph-anvil", desc: "Hunnen erobern die Waffenfabrik am Balkan.", quote: "Keine Waffen mehr für die Donau." },
            { year: 447, lat: 41.0, lng: 28.0, title: "Hunnen-Tribut", type: "diplomacy", desc: "Ostrom erkauft Frieden von Attila.", quote: "Gold statt Blut." },
            { 
                year: 451, lat: 49.0, lng: 4.0, title: "Katalaunische Felder", type: "battle", desc: "Die Völkerschlacht. Aetius stoppt Attila in Gallien.", quote: "Ein wilder Kampf.",
                vectors: [{dir: 'south', color: '#7e22ce'}, {dir: 'east', color: '#16a34a'}]
            }, 
            { year: 455, lat: 41.9, lng: 12.5, title: "Sack von Rom", type: "battle", desc: "Vandalen plündern Rom systematisch.", quote: null }, 
            { 
                year: 468, lat: 37.0, lng: 11.0, title: "Schlacht bei Kap Bon", type: "battle", icon: "ph-boat", desc: "Die gemeinsame Flotte von West- und Ostrom verbrennt. Die letzte Chance zur Rettung Westroms ist vertan.", quote: "Ein Meer aus Feuer.",
                vectors: [{dir: 'north', color: '#7e22ce'}, {dir: 'south', color: '#2563eb'}]
            },
            { year: 476, lat: 44.4, lng: 12.2, title: "Ende Westroms", type: "treaty", desc: "Odoaker setzt den letzten Kaiser ab.", quote: "Kein Kaiser mehr im Westen." }, 
            { year: 486, lat: 49.3, lng: 3.3, title: "Schlacht von Soissons", type: "battle", desc: "Chlodwig besiegt Syagrius.", quote: "Ende Roms in Gallien." }, 
            { year: 493, lat: 44.4, lng: 12.2, title: "Rabenschlacht", type: "treaty", desc: "Theoderich tötet Odoaker.", quote: "Der Verrat von Ravenna." },
            { year: 506, lat: 43.6, lng: 1.4, title: "Lex Romana Visigothorum", type: "law", icon: "ph-scroll", desc: "Kodifiziertes römisches Recht.", quote: "Rechtssicherheit als Machtinstrument." },
            { 
                year: 507, lat: 46.5, lng: 0.5, title: "Schlacht von Vouillé", type: "battle", desc: "Franken besiegen Westgoten.", quote: "Die Goten weichen nach Spanien.",
                vectors: [{dir: 'north', color: '#9333ea'}, {dir: 'south', color: '#dc2626'}]
            },
            { year: 529, lat: 37.98, lng: 23.72, title: "Ende der Akademie", type: "philosophy", icon: "ph-columns", desc: "Justinian schließt die Akademie.", quote: "Das Schweigen der Philosophen." },
            { year: 533, lat: 36.8, lng: 10.1, title: "Vandalenkrieg", type: "battle", desc: "Belisar landet in Afrika.", quote: "Justinians Traum." },
            { year: 533, lat: 41.0, lng: 28.9, title: "Digesten & Institutionen", type: "law", icon: "ph-book-open", desc: "Corpus Iuris Civilis.", quote: "Suum cuique tribuere." },
            { year: 536, lat: 42.0, lng: 12.5, title: "Vulkanischer Winter", type: "climate", icon: "ph-snowflake", duration: 10, desc: "Ein Jahr ohne Sommer.", quote: "Die Sonne gab ihr Licht ohne Strahl." },
            { year: 540, lat: 36.2, lng: 36.1, title: "Perserkrieg (Chosrau)", type: "crisis", desc: "Sassaniden plündern Antiochia.", quote: "Die zweite Front." },
            { year: 542, lat: 41.0, lng: 28.9, title: "Justinianische Pest", type: "plague", icon: "ph-skull", duration: 20, desc: "Pandemie tötet Millionen.", quote: "Gottes Zorn." },
            { year: 552, lat: 43.2, lng: 12.8, title: "Busta Gallorum", type: "battle", desc: "Narses besiegt Totila.", quote: "Ein blutiges Ende." }
        ];

        // --- LOGIK ---
        window.onload = function() { getApiKey(); initMap(); updateVisualization(375); };

        function setSpeed(level) {
            yearStep = speedConfig[level]; 
            
            document.querySelectorAll('[id^="speed-"]').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-black');
                btn.classList.add('text-stone-600', 'hover:bg-white');
            });
            const activeBtn = document.getElementById(`speed-${level}`);
            activeBtn.classList.add('bg-white', 'shadow-sm', 'text-black');
            activeBtn.classList.remove('text-stone-600');
        }

        function initMap() {
            map = L.map('map', { 
                zoomControl: true, 
                attributionControl: false,
                zoomSnap: 0.25, 
                zoomDelta: 0.25 
            }).setView([46.5, 14.0], 5);
            map.zoomControl.setPosition('topright');

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { attribution: '©OpenStreetMap, ©CartoDB' }).addTo(map);
            L.polyline(limesPath, { color: '#44403c', weight: 2, dashArray: '5, 10', opacity: 0.5 }).addTo(map);
            
            historicalRegions.forEach(reg => {
                const color = reg.color || '#78716c';
                L.tooltip({ permanent: true, direction: 'center', className: 'region-label', opacity: 0.8 }).setContent(`<span style="font-size:${reg.s}px; color:${color}">${reg.t}</span>`).setLatLng(reg.c).addTo(map);
            });

            // Ost-Bedrohung (Pfeil)
            const threatIcon = L.divIcon({
                className: 'bg-transparent',
                html: `<div class="flex items-center gap-2 opacity-0 transition-opacity duration-500" id="eastern-threat">
                        <i class="ph-fill ph-arrow-left text-4xl text-red-600 animate-pulse"></i>
                        <span class="text-xs font-bold text-red-800 bg-white/80 px-2 py-1 rounded">Sassaniden</span>
                       </div>`,
                iconSize: [120, 40],
                iconAnchor: [60, 20]
            });
            L.marker([36.0, 40.0], { icon: threatIcon }).addTo(map); // Nahe Antiochia

            dynamicCities.forEach((city, idx) => {
                let color = '#666'; if (city.type === 'capital') color = '#7e22ce'; if (city.type === 'barbarian') color = '#d97706'; if (city.type === 'monastery') color = '#0ea5e9'; 
                const marker = L.circleMarker(city.c, { radius: 4, color: color, fillColor: '#fff', fillOpacity: 1, weight: 2, opacity: 0 }).addTo(map);
                const tooltip = L.tooltip({ permanent: true, direction: 'bottom', className: 'bg-transparent border-0 shadow-none text-stone-500 font-serif text-[10px] uppercase tracking-wider', offset: [0, 5], opacity: 0 }).setContent(city.t).setLatLng(city.c).addTo(map);
                cityMarkers[idx] = { marker, tooltip, start: city.start, end: city.end };
            });

            climateLayer = L.circle([46.0, 15.0], { radius: 1500000, color: '#64748b', fillColor: '#94a3b8', fillOpacity: 0, opacity: 0, weight: 0 }).addTo(map);
            plagueLayer = L.circle([38.0, 18.0], { radius: 1500000, color: '#10b981', fillColor: '#10b981', fillOpacity: 0, opacity: 0, weight: 0 }).addTo(map);
            droughtLayer = L.circle([48.0, 40.0], { radius: 800000, color: '#d97706', fillColor: '#d97706', fillOpacity: 0, opacity: 0, weight: 0 }).addTo(map);

            initGrainLogistics();
            initGoldLogistics(); 
            initIronLogistics(); 
            initGranary(); 

            Object.keys(routes).forEach(key => {
                const data = routes[key];
                let dashStyle = '1, 6'; if (data.type === 'army') dashStyle = '10, 5'; if (data.type === 'plague') dashStyle = '1, 10'; 
                const line = L.polyline([], { color: data.color, weight: 4, opacity: 0.7, dashArray: dashStyle }).addTo(map);
                let borderRadius = '50%'; if (data.type === 'army') borderRadius = '2px';
                let iconClass = 'pulse-icon'; if (data.type === 'army') iconClass = 'pulse-icon roman-pulse'; if (data.type === 'plague') iconClass = 'pulse-icon plague-pulse';
                const iconHtml = `<div style="background-color: ${data.color}; width: 14px; height: 14px; border-radius: ${borderRadius}; border: 2px solid white;"></div>`;
                const icon = L.divIcon({ className: iconClass, html: iconHtml, iconSize: [14, 14], iconAnchor: [7, 7] });
                const marker = L.marker([0,0], { icon: icon }).addTo(map);
                marker.bindTooltip(data.name, { permanent: true, direction: 'right', className: 'custom-label', offset: [10, 0] });
                marker.on('click', () => showInfo(data.name, data.desc, null, data.color, key, data.artifact));
                layers[key] = { line, marker, hasStarted: false };
            });

            historicalEvents.forEach(ev => {
                let color = '#4b5563';
                if (ev.type === 'battle' || ev.type === 'crisis' || ev.type === 'plague') color = '#dc2626';
                else if (ev.type === 'climate') color = '#06b6d4';
                else if (ev.type === 'law') color = '#9333ea'; 
                
                let iconType = ev.icon || (ev.type === 'battle' ? 'ph-swords' : (ev.type === 'plague' ? 'ph-skull' : (ev.type === 'crisis' ? 'ph-fire' : (ev.type === 'diplomacy' ? 'ph-handshake' : 'ph-snowflake'))));
                const pulseClass = ev.type === 'climate' || ev.type === 'plague' ? 'climate-pulse' : '';
                const html = `<div class="battle-marker flex items-center justify-center w-8 h-8 bg-white rounded-full shadow-md border border-stone-200 text-[${color}] ${pulseClass}"><i class="ph-fill ${iconType} text-lg" style="color:${color}"></i></div>`;
                const icon = L.divIcon({ className: 'bg-transparent', html: html, iconSize: [32, 32], iconAnchor: [16, 16] });
                const marker = L.marker([ev.lat, ev.lng], { icon: icon, opacity: 0 }).addTo(map);
                marker.on('click', () => showInfo(ev.title, ev.desc, ev.quote, color, null, null));
                eventMarkers[ev.year] = marker;
            });
        }

        function initGrainLogistics() {
            grainRouteLayer = L.polyline(grainPathCoords, {
                color: '#d97706', 
                weight: 5,
                dashArray: '4, 8', 
                className: 'grain-route-line', 
                opacity: 0.8
            }).addTo(map);

            const iconHtml = `<div id="rome-icon-inner" class="flex items-center justify-center w-8 h-8 bg-white rounded-full border-2 border-amber-500 shadow-md transition-all duration-500 cursor-pointer hover:scale-110 transition-transform"><i class="ph-fill ph-grains text-amber-600 text-lg"></i></div>`;
            const divIcon = L.divIcon({ className: 'bg-transparent', html: iconHtml, iconSize: [32, 32], iconAnchor: [16, 36] });

            const infoTitle = "Die Cura Annonae (Getreideversorgung)";
            const infoText = "Rom und Konstantinopel hingen am Tropf der nordafrikanischen und ägyptischen Kornkammern. Die 'Cura Annonae' verteilte kostenloses Brot an bis zu 200.000 Bürger. Als die Vandalen 439 Karthago nahmen, brach diese Lebensader. Die Bevölkerung Roms schrumpfte innerhalb weniger Jahrzehnte von 800.000 auf unter 50.000.";
            const infoArtifact = { img: artifacts.grain, title: "Annona-Schiff", text: "Getreidefrachter auf einem Mosaik." };

            romeStatusIcon = L.marker([41.9, 12.5], { icon: divIcon, zIndexOffset: 1000 }).addTo(map);
            romeStatusIcon.bindTooltip("Annona: Aktiv", { direction: 'top', className: 'custom-label' });
            romeStatusIcon.on('click', () => showInfo(infoTitle, infoText, "Panem et circenses.", "#d97706", null, infoArtifact));
        }

        function initGoldLogistics() {
            goldRouteLayer = L.polyline(goldPathCoords, {
                color: '#fbbf24', 
                weight: 4,
                dashArray: '2, 10', 
                className: 'gold-route-line', 
                opacity: 0.9
            }).addTo(map);

            const iconHtml = `<div id="ravenna-icon-inner" class="flex items-center justify-center w-8 h-8 bg-white rounded-full border-2 border-yellow-500 shadow-md transition-all duration-500 cursor-pointer hover:scale-110 transition-transform"><i class="ph-fill ph-coins text-yellow-600 text-lg"></i></div>`;
            const divIcon = L.divIcon({ className: 'bg-transparent', html: iconHtml, iconSize: [32, 32], iconAnchor: [16, 36] });

            const infoTitle = "Der Solidus: Das Rückgrat der Wirtschaft";
            const infoText = "Der Solidus war die 'Leitwährung' der Spätantike, berühmt für seinen hohen Goldgehalt. Er finanzierte die endlosen Kriege und Tribute an die Barbaren ('Scheckbuch-Diplomatie'). Als die Sueben 409 die Goldminen von Gallaecia (Spanien) besetzten, verlor Westrom seine wichtigste Einnahmequelle für Hartwährung. Ohne Gold keine Söldner.";
            const infoArtifact = { img: artifacts.coin, title: "Solidus", text: "Goldmünze mit Kaiserportrait." };

            goldStatusIcon = L.marker([44.4, 12.2], { icon: divIcon, zIndexOffset: 1000 }).addTo(map);
            goldStatusIcon.bindTooltip("Aurum: Gesichert", { direction: 'top', className: 'custom-label' });
            goldStatusIcon.on('click', () => showInfo(infoTitle, infoText, "Pecunia nervus belli.", "#ca8a04", null, infoArtifact));

            const mineHtml = `<div id="mine-icon-inner" class="text-yellow-500 drop-shadow-md"><i class="ph-fill ph-mountains text-2xl"></i></div>`;
            const mineIcon = L.divIcon({ className: 'bg-transparent', html: mineHtml, iconSize: [24, 24], iconAnchor: [12, 24] });
            mineMarker = L.marker([42.46, -6.8], { icon: mineIcon, opacity: 1 }).addTo(map);
        }

        function initIronLogistics() {
            const ironHtml = `<div class="flex items-center justify-center w-8 h-8 bg-white rounded-full border-2 border-slate-500 shadow-md cursor-pointer hover:scale-110 transition-transform"><i class="ph-fill ph-hammer text-slate-600 text-lg"></i></div>`;
            const ironIcon = L.divIcon({ className: 'bg-transparent', html: ironHtml, iconSize: [32, 32], iconAnchor: [16, 16] });
            
            const infoTitle = "Römische Rüstungsindustrie (Fabricae)";
            const infoText = "Seit der Reform Diokletians war die Waffenproduktion staatlich zentralisiert. Riesige Manufakturen (Fabricae) produzierten am Fließband: Trier lieferte Schilde und Geschütze für den Rhein, Sirmium Waffen für den Balkan. Die Arbeiter waren militärisch organisiert und 'gebrandmarkt', um Flucht zu verhindern. Der Verlust dieser Zentren bedeutete das technologische Ende der Legionen.";
            const infoArtifact = { img: artifacts.fabrica, title: "Fabrica", text: "Stilisierte Darstellung einer Waffenfabrik." };

            let m1 = L.marker([49.75, 6.63], { icon: ironIcon, opacity: 1 }).addTo(map);
            m1.bindTooltip("Fabrica (Waffen)", { direction: 'top', className: 'custom-label', offset: [0, -10] });
            m1.on('click', () => showInfo(infoTitle, infoText, "Ferrum vincit omnia.", "#475569", null, infoArtifact));
            fabricaeMarkers.push({ m: m1, end: 413 });

            let m2 = L.marker([44.9, 19.6], { icon: ironIcon, opacity: 1 }).addTo(map);
            m2.bindTooltip("Fabrica (Waffen)", { direction: 'top', className: 'custom-label', offset: [0, -10] });
            m2.on('click', () => showInfo(infoTitle, infoText, "Ferrum vincit omnia.", "#475569", null, infoArtifact));
            fabricaeMarkers.push({ m: m2, end: 441 });

            ironPaths.forEach(p => {
                let line = L.polyline(p.path, {
                    color: '#475569', 
                    weight: 4,        
                    dashArray: '5, 10',
                    className: 'iron-route-line',
                    opacity: 0.9
                }).addTo(map);
                ironRoutes.push({ l: line, end: p.end });
            });
        }

        function initGranary() {
            const locations = [ [36.5, 9.5], [36.0, 8.0], [35.5, 10.0], [36.8, 10.5] ];
            locations.forEach(loc => {
                const iconHtml = `<div class="wheat-icon-inner text-amber-500 drop-shadow-sm"><i class="ph-fill ph-plant text-2xl"></i></div>`;
                const icon = L.divIcon({ className: 'bg-transparent', html: iconHtml, iconSize: [24, 24], iconAnchor: [12, 24] });
                const m = L.marker(loc, { icon: icon, opacity: 1 }).addTo(map);
                granaryMarkers.push(m);
            });
        }

        function getPosition(path, year) {
            if (year < path[0][2]) return null;
            if (year >= path[path.length - 1][2]) return { lat: path[path.length-1][0], lng: path[path.length-1][1], trail: path.map(p => [p[0], p[1]]) };
            for (let i = 0; i < path.length - 1; i++) {
                if (year >= path[i][2] && year < path[i+1][2]) {
                    const f = (year - path[i][2]) / (path[i+1][2] - path[i][2]);
                    return { lat: path[i][0] + (path[i+1][0] - path[i][0]) * f, lng: path[i][1] + (path[i+1][1] - path[i][1]) * f, trail: [...path.slice(0, i+1).map(p=>[p[0],p[1]]), [path[i][0] + (path[i+1][0] - path[i][0]) * f, path[i][1] + (path[i+1][1] - path[i][1]) * f]] };
                }
            }
            return null;
        }

        function updateBattleVisuals(event) {
            if (!event.vectors || activeBattleAnimations[event.year]) return;

            activeBattleAnimations[event.year] = [];

            const shockHtml = `<div class="shockwave-effect"></div>`;
            const shockIcon = L.divIcon({ className: 'bg-transparent', html: shockHtml, iconSize: [40, 40], iconAnchor: [20, 20] });
            const shockMarker = L.marker([event.lat, event.lng], { icon: shockIcon, zIndexOffset: 5000, interactive: false }).addTo(map);
            activeBattleAnimations[event.year].push(shockMarker);

            event.vectors.forEach(v => {
                const vecHtml = `<div class="battle-svg-container arrow-anim-${v.dir}" style="color:${v.color}">${battleArrowSVG}</div>`;
                const vecIcon = L.divIcon({ className: 'bg-transparent', html: vecHtml, iconSize: [64, 64], iconAnchor: [32, 32] });
                const vecMarker = L.marker([event.lat, event.lng], { icon: vecIcon, zIndexOffset: 5001, interactive: false }).addTo(map);
                activeBattleAnimations[event.year].push(vecMarker);
            });

            setTimeout(() => {
                if (activeBattleAnimations[event.year]) {
                    activeBattleAnimations[event.year].forEach(m => map.removeLayer(m));
                    delete activeBattleAnimations[event.year];
                }
            }, 4000);
        }

        function updateVisualization(year) {
            
            const aiYearEl = document.getElementById('tribe-ai-year'); if (aiYearEl) aiYearEl.innerText = Math.floor(year);
            const aiBtnRef = document.getElementById('ai-btn-year-ref'); if (aiBtnRef) aiBtnRef.innerText = Math.floor(year);
            
            Object.values(cityMarkers).forEach(cm => {
                if (year >= cm.start && year <= cm.end) { cm.marker.setStyle({ opacity: 1, fillOpacity: 1 }); cm.tooltip.setOpacity(1); } else { cm.marker.setStyle({ opacity: 0, fillOpacity: 0 }); cm.tooltip.setOpacity(0); }
            });

            const alertDiv = document.getElementById('narrative-alert');
            const alertBtn = document.getElementById('alert-btn');
            const alertIcon = document.getElementById('alert-icon');
            const alertType = document.getElementById('alert-type');
            const alertTitle = document.getElementById('alert-title');
            
            if (year >= 370 && year <= 400) { let op = 0.3; if(year < 375) op = (year - 370) * 0.06; if(year > 385) op = 0.3 - ((year - 385) * 0.02); droughtLayer.setStyle({ fillOpacity: Math.max(0, op), opacity: 0 }); } else { droughtLayer.setStyle({ fillOpacity: 0 }); }
            if (year >= 536 && year <= 545) { let op = 0.3; if(year > 538) op = 0.3 - ((year - 538) * 0.04); climateLayer.setStyle({ fillOpacity: Math.max(0, op), opacity: 0 }); } else { climateLayer.setStyle({ fillOpacity: 0 }); }
            if (year >= 541 && year <= 560) { let op = 0.3; if(year > 545) op = 0.3 - ((year - 545) * 0.02); plagueLayer.setStyle({ fillOpacity: Math.max(0, op), opacity: 0 }); } else { plagueLayer.setStyle({ fillOpacity: 0 }); }

            if (grainRouteLayer && romeStatusIcon) {
                const vandalConquest = 439;
                const byzantineReconquest = 533;
                const routeActive = (year < vandalConquest) || (year > byzantineReconquest);
                const iconInner = document.getElementById('rome-icon-inner');
                
                if (routeActive) {
                    if (!map.hasLayer(grainRouteLayer)) map.addLayer(grainRouteLayer);
                    if(iconInner) {
                        iconInner.className = "flex items-center justify-center w-8 h-8 bg-white rounded-full border-2 border-amber-500 shadow-md";
                        iconInner.innerHTML = '<i class="ph-fill ph-grains text-amber-600 text-lg"></i>';
                    }
                    romeStatusIcon.setTooltipContent("Annona: Gesichert");
                } else {
                    if (map.hasLayer(grainRouteLayer)) map.removeLayer(grainRouteLayer);
                    if(iconInner) {
                        iconInner.className = "flex items-center justify-center w-8 h-8 bg-red-50 rounded-full border-2 border-red-600 shadow-md famine-marker";
                        iconInner.innerHTML = '<i class="ph-fill ph-warning text-red-600 text-lg"></i>';
                    }
                    romeStatusIcon.setTooltipContent("Annona: UNTERBROCHEN (Hungersnot)");
                }

                granaryMarkers.forEach(m => {
                    if (routeActive) m.setOpacity(1); else m.setOpacity(0);
                });
            }

            if (goldRouteLayer && goldStatusIcon && mineMarker) {
                const suebiConquest = 409; 
                const routeActive = (year < suebiConquest);
                const iconInner = document.getElementById('ravenna-icon-inner');
                const mineInner = document.getElementById('mine-icon-inner');

                if (routeActive) {
                    if (!map.hasLayer(goldRouteLayer)) map.addLayer(goldRouteLayer);
                    if(iconInner) {
                        iconInner.className = "flex items-center justify-center w-8 h-8 bg-white rounded-full border-2 border-yellow-500 shadow-md";
                        iconInner.innerHTML = '<i class="ph-fill ph-coins text-yellow-600 text-lg"></i>';
                    }
                    goldStatusIcon.setTooltipContent("Aurum: Solidi fließen");
                    mineMarker.setOpacity(1);
                    if(mineInner) mineInner.className = "text-yellow-500 drop-shadow-md";
                } else {
                    if (map.hasLayer(goldRouteLayer)) map.removeLayer(goldRouteLayer);
                    if(iconInner) {
                        iconInner.className = "flex items-center justify-center w-8 h-8 bg-red-50 rounded-full border-2 border-red-600 shadow-md";
                        iconInner.innerHTML = '<i class="ph-fill ph-prohibit text-red-600 text-lg"></i>';
                    }
                    goldStatusIcon.setTooltipContent("Aurum: INSOLVENZ (Verlust Spaniens)");
                    mineMarker.setOpacity(0.5); 
                    if(mineInner) mineInner.className = "text-stone-400 drop-shadow-none";
                }
            }

            fabricaeMarkers.forEach(f => {
                if (year < f.end) {
                    f.m.setOpacity(1); 
                } else {
                    f.m.setOpacity(0.3);
                }
            });
            ironRoutes.forEach(r => {
                if (year < r.end) { if(!map.hasLayer(r.l)) map.addLayer(r.l); } else { if(map.hasLayer(r.l)) map.removeLayer(r.l); }
            });

            // Ostrom-Bedrohung (Pulsieren bei Konflikt)
            const easternThreat = document.getElementById('eastern-threat');
            if (easternThreat) {
                 if (activeAlertEvent && activeAlertEvent.title.includes('Perser')) {
                     easternThreat.classList.remove('opacity-0');
                 } else {
                     easternThreat.classList.add('opacity-0');
                 }
            }

            Object.keys(kingdoms).forEach(k => {
                const kd = kingdoms[k];
                if (year >= kd.start && year <= kd.end) {
                    if (!kingdomLayers[k]) {
                        kingdomLayers[k] = L.circle(kd.center, {
                            radius: 10, 
                            color: kd.color,
                            fillColor: kd.color,
                            fillOpacity: 0.2,
                            weight: 2
                        }).addTo(map);
                        kingdomLayers[k].bindTooltip(kd.name, { permanent: true, direction: 'center', className: 'custom-label' });
                    }
                    let targetRadius = kd.radius;
                    let currentR = kingdomLayers[k].getRadius();
                    if (currentR < targetRadius) {
                        kingdomLayers[k].setRadius(currentR + (targetRadius - currentR) * 0.1);
                    }
                } else {
                    if (kingdomLayers[k]) {
                        map.removeLayer(kingdomLayers[k]);
                        delete kingdomLayers[k];
                    }
                }
            });

            let currentEvents = historicalEvents.filter(ev => year >= ev.year && year <= (ev.year + (ev.duration || 2)));
            if (currentEvents.length > 0) {
                currentEvents.sort((a, b) => { const p = { 'plague': 3, 'climate': 3, 'crisis': 3, 'battle': 2, 'law': 2, 'philosophy': 2, 'move': 2, 'treaty': 1 }; return (p[b.type] || 0) - (p[a.type] || 0); });
                let ev = currentEvents[0];
                
                if (!activeAlertEvent || activeAlertEvent.title !== ev.title) {
                    let btnClass = 'alert-card'; let icon = 'ph-info'; let typeText = 'Ereignis';
                    let borderClass = 'border-stone-400';

                    if (ev.type === 'battle') { borderClass = 'border-battle'; icon = 'ph-swords'; typeText = 'Militärischer Konflikt'; }
                    else if (ev.type === 'treaty' || ev.type === 'diplomacy') { borderClass = 'border-treaty'; icon = 'ph-scroll'; typeText = 'Politische Zäsur'; }
                    else if (ev.type === 'move') { borderClass = 'border-move'; icon = 'ph-arrows-left-right'; typeText = 'Migration'; }
                    else if (ev.type === 'climate' || ev.type === 'drought') { 
                        borderClass = 'border-nature';
                        if(ev.type === 'drought') { icon = 'ph-sun-dim'; typeText = 'Ökologische Krise'; }
                        else { icon = 'ph-snowflake'; typeText = 'Klima-Anomalie'; }
                    }
                    else if (ev.type === 'plague') { borderClass = 'border-plague'; icon = 'ph-skull'; typeText = 'Pandemie'; }
                    else if (ev.type === 'crisis') { borderClass = 'border-battle'; icon = 'ph-fire'; typeText = 'Reichskrise'; }
                    else if (ev.type === 'law') { borderClass = 'border-law'; icon = 'ph-scales'; typeText = 'Rechtsgeschichte'; }
                    else if (ev.type === 'philosophy') { borderClass = 'border-law'; icon = 'ph-columns'; typeText = 'Philosophie & Geist'; }

                    alertBtn.className = `alert-card px-6 py-4 rounded-r-lg flex items-center gap-4 cursor-pointer hover:scale-105 transition-transform min-w-[340px] max-w-lg justify-between group border-l-4 ${borderClass}`;
                    alertIcon.className = `ph-fill text-3xl text-stone-700 ${icon}`;
                    alertType.innerText = typeText;
                    alertTitle.innerText = ev.title;

                    if (ev.type === 'battle') {
                        updateBattleVisuals(ev);
                    }
                }
                activeAlertEvent = ev; 
                alertDiv.classList.remove('hidden');
            } else { 
                alertDiv.classList.add('hidden'); 
                activeAlertEvent = null; 
            }

            Object.keys(routes).forEach(key => {
                const res = getPosition(routes[key].path, year);
                const layerData = layers[key]; 
                if (res) {
                    if (!layerData.hasStarted) { layerData.marker.setOpacity(1); layerData.line.setStyle({opacity: 0.7}); layerData.hasStarted = true; }
                    layerData.marker.setLatLng([res.lat, res.lng]); layerData.line.setLatLngs(res.trail);
                    const isHunnenEnd = (key === 'hunnen' && year > 454);
                    const isStilichoEnd = (key === 'stilicho' && year > 408);
                    const isAetiusEnd = (key === 'aetius' && year > 454);
                    if (isHunnenEnd || isStilichoEnd || isAetiusEnd) { layerData.marker.setOpacity(0); layerData.marker.closeTooltip(); layerData.line.setStyle({opacity: 0.15}); } 
                    else { layerData.marker.setOpacity(1); if(!layerData.marker.isTooltipOpen()) layerData.marker.openTooltip(); layerData.line.setStyle({opacity: 0.7}); }
                } else { layerData.marker.setOpacity(0); layerData.marker.closeTooltip(); layerData.line.setLatLngs([]); layerData.hasStarted = false; }
            });
            
            historicalEvents.forEach(ev => {
                const marker = eventMarkers[ev.year]; if (!marker) return;
                const duration = ev.duration || 2; const endYear = ev.year + duration;
                if (year >= ev.year && year <= endYear) {
                    let opacity = 1; if (duration > 5) { opacity = 1 - ((year - ev.year) / duration * 0.8); }
                    marker.setOpacity(opacity);
                } else { marker.setOpacity(0); }
            });
        }

        // WIRD VOM SLIDER AUFGERUFEN (MANUELL)
        function updateYear(val) { 
            const y = parseFloat(val); 
            currentYear = y; // Sync manuell -> intern
            document.getElementById('year-display').innerText = Math.floor(y); 
            updateVisualization(y); 
        }
        
        // --- ANIMATION LOOP (FIXED: USE INTERNAL STATE) ---
        function gameLoop(timestamp) {
            if (!lastFrameTime) lastFrameTime = timestamp;
            const deltaTime = timestamp - lastFrameTime;

            if (deltaTime >= 33) { // ca 30 FPS Limit
                
                // BULLET TIME LOGIK
                let effectiveStep = yearStep;
                if (activeAlertEvent) {
                    effectiveStep = yearStep * 0.10; 
                }

                if (currentYear >= 568) currentYear = 375;
                else currentYear += effectiveStep;

                const slider = document.getElementById('year-slider');
                slider.value = currentYear;
                
                document.getElementById('year-display').innerText = Math.floor(currentYear); 
                updateVisualization(currentYear);
                
                lastFrameTime = timestamp;
            }

            if (isPlaying) {
                animationId = requestAnimationFrame(gameLoop);
            }
        }

        function startAnimation() {
            if (!isPlaying) return;
            lastFrameTime = 0;
            animationId = requestAnimationFrame(gameLoop);
        }

        function togglePlay() {
            const btn = document.getElementById('play-icon');
            if (isPlaying) {
                isPlaying = false;
                cancelAnimationFrame(animationId);
                btn.classList.remove('ph-pause'); btn.classList.add('ph-play');
                btn.parentElement.classList.remove('bg-red-600'); btn.parentElement.classList.add('bg-stone-800');
            } else {
                isPlaying = true;
                btn.classList.remove('ph-play'); btn.classList.add('ph-pause');
                btn.parentElement.classList.remove('bg-stone-800'); btn.parentElement.classList.add('bg-red-600');
                startAnimation();
            }
        }

        function showInfo(title, text, quote, color, key, artifact) {
            currentTribeForAI = key ? { name: title, key: key } : null;
            const box = document.getElementById('info-box');
            const artContainer = document.getElementById('info-artifact-container');
            const aiSection = document.getElementById('tribe-ai-section');

            document.getElementById('info-title').innerText = title; document.getElementById('info-title').style.color = color;
            document.getElementById('info-content').innerText = text;

            if (artifact) {
                artContainer.classList.remove('hidden');
                const img = document.getElementById('artifact-img');
                img.onerror = function() { this.onerror = null; this.src = artifact.fallback; };
                img.src = artifact.img;
                document.getElementById('artifact-title').innerText = artifact.title;
                document.getElementById('artifact-desc').innerText = artifact.text;
                document.getElementById('artifact-desc').classList.remove('hidden');
            } else { artContainer.classList.add('hidden'); document.getElementById('artifact-desc').classList.add('hidden'); }

            if (quote) { document.getElementById('info-quote').innerText = quote; document.getElementById('info-quote').classList.remove('hidden'); } else { document.getElementById('info-quote').classList.add('hidden'); }
            if (key) { aiSection.classList.remove('hidden'); } else { aiSection.classList.add('hidden'); }
            
            document.getElementById('tribe-ai-response').classList.add('hidden'); document.getElementById('tribe-ai-response').innerHTML = '';
            box.classList.remove('hidden');
        }

        function closeInfo() { document.getElementById('info-box').classList.add('hidden'); }
        function closeAiModal() { document.getElementById('ai-modal').classList.add('hidden'); }

        async function callGemini(prompt) {
            const key = getApiKey();
            if (!key) return "FEHLER: Kein API-Key gespeichert.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`;
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (!response.ok) {
                    const err = await response.json();
                    if(response.status === 403) return `<b>API Fehler (403):</b> Key abgelehnt.`;
                    return `<b>API Fehler (${response.status}):</b> ${err.error?.message}`;
                }
                const data = await response.json(); return data.candidates[0].content.parts[0].text;
            } catch (error) { return `<b>Netzwerkfehler:</b> ${error.message}`; }
        }
        
        // --- CHAT SYSTEM ---
        function appendMessage(role, text) {
            const historyDiv = document.getElementById('ai-chat-history');
            const isUser = role === 'user';
            
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            div.innerHTML = `
                <div class="max-w-[85%] rounded-2xl px-5 py-3 shadow-sm ${
                    isUser 
                    ? 'bg-stone-200 text-stone-800 rounded-tr-none' 
                    : 'bg-white border border-stone-200 text-stone-800 rounded-tl-none font-serif leading-relaxed'
                }">
                    ${isUser ? '' : '<div class="mb-1 text-[10px] uppercase tracking-widest text-purple-600 font-bold">Analyse</div>'}
                    ${formatText(text)}
                </div>
            `;
            historyDiv.appendChild(div);
            historyDiv.scrollTop = historyDiv.scrollHeight; 
        }

        async function askGeminiContext() {
            const modal = document.getElementById('ai-modal');
            const historyDiv = document.getElementById('ai-chat-history');
            const year = Math.floor(currentYear);
            
            document.getElementById('ai-modal-year').innerText = year;
            modal.classList.remove('hidden');
            historyDiv.innerHTML = ''; 
            chatHistory = []; 

            const prompt = `Du bist ein spezialisierter Althistoriker und Kulturwissenschaftler. Analysiere das Jahr ${year} n. Chr. Fokus: Geopolitik, Sozialgeschichte, Logistik und Mentalitätsgeschichte. Vermeide anachronistische moderne Rechtsbegriffe. Antworte präzise, elegant, essayistisch und auf Deutsch.`;
            
            appendMessage('ai', '<i class="ph-bold ph-spinner animate-spin"></i> Analysiere Quellenlage...');
            const result = await callGemini(prompt);
            historyDiv.lastElementChild.remove();
            appendMessage('ai', result);
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            chatHistory.push({ role: "model", parts: [{ text: result }] });
        }

        async function sendFollowUp() {
            const input = document.getElementById('ai-user-input');
            const text = input.value.trim();
            if (!text) return;

            appendMessage('user', text);
            input.value = '';
            
            appendMessage('ai', '<i class="ph-bold ph-spinner animate-spin"></i>');

            const chatSession = {
                contents: [...chatHistory, { role: "user", parts: [{ text: text }] }]
            };

            const key = getApiKey();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`; 

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(chatSession)
                });
                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;

                const loadingMsg = document.getElementById('ai-chat-history').lastElementChild;
                if(loadingMsg) loadingMsg.remove();
                
                appendMessage('ai', reply);
                
                chatHistory.push({ role: "user", parts: [{ text: text }] });
                chatHistory.push({ role: "model", parts: [{ text: reply }] });

            } catch (e) {
                appendMessage('ai', `Fehler: ${e.message}`);
            }
        }

        async function askGeminiTribe() {
            if (!currentTribeForAI) return;
            const respDiv = document.getElementById('tribe-ai-response'); respDiv.classList.remove('hidden');
            respDiv.innerHTML = `<div class="flex items-center gap-3 py-2"><div class="ai-spinner"></div><span class="italic text-stone-500 text-xs">Recherchiere ${currentTribeForAI.name}...</span></div>`;
            const prompt = `Du bist ein Experte für Spätantike. Thema: Die Gruppe '${currentTribeForAI.name}' im Jahr ${Math.floor(currentYear)} n. Chr. Erkläre präzise ihre Situation (Ort, Rechtsstatus im antiken Sinn, Anführer, militärische Ziele). 2-3 Sätze, Deutsch.`;
            const result = await callGemini(prompt); respDiv.innerHTML = formatText(result);
        }

        async function askGeminiEvent() {
            if (!activeAlertEvent) return;
            
            const modal = document.getElementById('ai-modal');
            const historyDiv = document.getElementById('ai-chat-history');
            
            document.getElementById('ai-modal-year').innerText = activeAlertEvent.title; 
            modal.classList.remove('hidden');
            historyDiv.innerHTML = ''; 
            chatHistory = []; 

            const promptText = activeAlertEvent.aiPrompt || `Analysiere das Ereignis '${activeAlertEvent.title}' im Jahr ${activeAlertEvent.year}.`;
            const prompt = `Du bist ein Althistoriker. Analysiere das Ereignis aus historischer und strategischer Sicht (Ursachen, unmittelbare Folgen, zeitgenössische Wahrnehmung). Vermeide moderne juristische Bewertungen (wie Völkerrecht). ${promptText} Antworte präzise und auf Deutsch.`;

            appendMessage('ai', '<i class="ph-bold ph-spinner animate-spin"></i> Untersuche Ereignis...');
            const result = await callGemini(prompt);
            historyDiv.lastElementChild.remove();
            appendMessage('ai', result);
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            chatHistory.push({ role: "model", parts: [{ text: result }] });
        }
    </script>
</body>
</html>
