<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Völkerwanderung: Interaktive Analyse</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        /* API KEY LOGIK */
        function getApiKey() {
            let key = localStorage.getItem('gemini_api_key');
            if (!key) {
                setTimeout(() => document.getElementById('key-modal').classList.remove('hidden'), 1000);
                return null;
            }
            return key;
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                document.getElementById('key-modal').classList.add('hidden');
                alert("Schlüssel gespeichert! Analyse aktiv.");
                location.reload(); 
            }
        }

        function clearApiKey() {
            localStorage.removeItem('gemini_api_key');
            alert("Schlüssel entfernt.");
            location.reload();
        }

        /* BILDER & LOGIK HELPER */
        const fallbackImage = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300' fill='%23f5f5f4'%3E%3Crect width='400' height='300' fill='%23e5e5e5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' fill='%23999'%3EBild nicht verfügbar%3C/text%3E%3C/svg%3E";
        
        const localImages = {
            westgoten: './img/westgoten.jpg', vandalen: './img/vandalen.jpg',
            hunnen: './img/hunnen.jpg', langobarden: './img/langobarden.jpg',
            franken: './img/franken.jpg', ostgoten: './img/ostgoten.jpg',
            rom: './img/rom_armee.jpg', pest: './img/pest.jpg'
        };

        const artifacts = {
            westgoten: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M200 50 C230 50 250 80 250 100 L280 150 L200 250 L120 150 L150 100 C150 80 170 50 200 50' fill='%23b91c1c' stroke='%23b45309' stroke-width='5'/%3E%3Ccircle cx='200' cy='90' r='15' fill='%2378350f' stroke='%23fcd34d' stroke-width='3'/%3E%3C/svg%3E`,
            vandalen: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Ccircle cx='200' cy='150' r='100' fill='%23cbd5e1' stroke='%2394a3b8' stroke-width='4'/%3E%3Ctext x='200' y='280' text-anchor='middle' font-family='serif' font-weight='bold' fill='%2364748b' font-size='18' letter-spacing='2'%3ED N REX GELIMER%3C/text%3E%3C/svg%3E`,
            hunnen: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M200 60 C240 60 260 100 260 140 L240 260 L160 260 L140 140 C140 100 160 60 200 60' fill='%2365a30d' stroke='%23fcd34d' stroke-width='4'/%3E%3C/svg%3E`,
            langobarden: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Crect x='180' y='50' width='40' height='200' fill='%23fcd34d' stroke='%23b45309' stroke-width='2'/%3E%3Crect x='100' y='110' width='200' height='40' fill='%23fcd34d' stroke='%23b45309' stroke-width='2'/%3E%3C/svg%3E`,
            franken: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M200 80 C220 80 240 100 240 130 C240 160 200 220 200 220 C200 220 160 160 160 130 C160 100 180 80 200 80' fill='%23fbbf24' stroke='%23b45309' stroke-width='2'/%3E%3Cpath d='M160 130 L120 110' fill='%23ef4444'/%3E%3Cpath d='M240 130 L280 110' fill='%23ef4444'/%3E%3C/svg%3E`,
            ostgoten: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M200 40 L240 80 L220 180 L200 260 L180 180 L160 80 Z' fill='%23be123c' stroke='%23fbbf24' stroke-width='4'/%3E%3C/svg%3E`,
            rom: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cdefs%3E%3CradialGradient id='shield' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' style='stop-color:%237e22ce;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23581c87;stop-opacity:1' /%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='200' cy='150' r='110' fill='url(%23shield)' stroke='%23fbbf24' stroke-width='8'/%3E%3Cpath d='M200 60 L200 240 M150 100 L250 200 M250 100 L150 200' stroke='%23fbbf24' stroke-width='12' stroke-linecap='round'/%3E%3Cpath d='M200 60 C220 40 240 60 230 80' stroke='%23fbbf24' stroke-width='8' fill='none'/%3E%3C/svg%3E`,
            pest: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300' style='background:%23f5f5f4'%3E%3Cpath d='M100 150 Q150 50 250 150 T350 150' fill='none' stroke='%2310b981' stroke-width='10'/%3E%3Ccircle cx='200' cy='120' r='40' fill='%23064e3b'/%3E%3Crect x='180' y='180' width='40' height='60' fill='%23064e3b'/%3E%3Cpath d='M180 240 L220 280 M220 240 L180 280' stroke='%2310b981' stroke-width='5'/%3E%3Ctext x='200' y='280' text-anchor='middle' fill='%2310b981' font-family='sans-serif' font-weight='bold' font-size='24' letter-spacing='2'%3EYERSINIA PESTIS%3C/text%3E%3C/svg%3E`
        };

        function formatText(text) {
            if (!text) return '';
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }
    </script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100vw; background: #d6d3d1; z-index: 1; }
        .ui-layer { position: absolute; z-index: 3000; pointer-events: none; }
        .ui-element { pointer-events: auto; }
        .pointer-events-auto { pointer-events: auto !important; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #d97706; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); cursor: pointer; margin-top: -10px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #a8a29e; border-radius: 2px; }

        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(2.0); opacity: 0; } }
        @keyframes alert-pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(255, 255, 255, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }

        .pulse-icon { position: relative; }
        .pulse-icon:after { content: ''; position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 50%; background: inherit; animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; z-index: -1; }
        .roman-pulse:after { border: 2px solid #7e22ce; animation: pulse-ring 2s infinite; }
        .climate-pulse:after { border: 2px solid #06b6d4; animation: pulse-ring 2.5s infinite; background: rgba(6,182,212,0.1); }
        .plague-pulse:after { border: 2px solid #10b981; animation: pulse-ring 1s infinite; background: rgba(16, 185, 129, 0.2); }
        
        .alert-base { animation: alert-pulse 2.5s infinite; color: white; border: 1px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(4px); }
        .alert-nature { background: linear-gradient(135deg, #0891b2, #3b82f6); border-color: #a5f3fc; }
        .alert-drought { background: linear-gradient(135deg, #ea580c, #b45309); border-color: #fdba74; }
        .alert-plague  { background: linear-gradient(135deg, #059669, #047857); border-color: #6ee7b7; }
        .alert-battle { background: linear-gradient(135deg, #dc2626, #991b1b); border-color: #fca5a5; }
        .alert-treaty { background: linear-gradient(135deg, #7e22ce, #581c87); border-color: #d8b4fe; }
        .alert-move { background: linear-gradient(135deg, #4f46e5, #312e81); border-color: #a5b4fc; }

        .ai-spinner { border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 3px solid #9333ea; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .leaflet-tooltip.custom-label { background-color: rgba(255, 255, 255, 0.95); border: 1px solid #999; color: #333; font-family: serif; font-weight: bold; font-size: 12px; padding: 2px 6px; border-radius: 2px; }
        .leaflet-tooltip.region-label { background: transparent; border: none; box-shadow: none; font-family: 'Times New Roman', serif; font-weight: bold; color: #333; text-transform: uppercase; letter-spacing: 0.15em; font-size: 14px; opacity: 0.9; pointer-events: none; text-shadow: 1px 1px 0px rgba(255,255,255,0.8); }
        
        .culture-marker { background: #fff; border: 2px solid #d97706; color: #d97706; box-shadow: 0 0 10px rgba(217, 119, 6, 0.4); animation: pulse-culture 3s infinite; }
        @keyframes pulse-culture { 0% { box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(217, 119, 6, 0); } 100% { box-shadow: 0 0 0 0 rgba(217, 119, 6, 0); } }

        /* KLARHEIT & NATÜRLICHKEIT */
        .leaflet-layer { 
            /* Sepia entfernt, Kontrast natürlich gehalten */
            filter: contrast(1.05); 
        }

        /* Textur nur minimal, um "Digital-Look" zu brechen, aber ohne Nebel */
        .parchment-overlay {
            position: absolute; inset: 0; pointer-events: none; z-index: 2000;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.1);
            mix-blend-mode: multiply;
        }

        /* Straßen: Dezent, braun, in die Karte "geprägt" */
        .road-relief { 
            mix-blend-mode: multiply; 
            opacity: 0.7;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Flüsse: Klares, natürliches Wasserblau */
        .river-style {
            stroke: #3b82f6; 
            opacity: 0.75;
            stroke-linecap: round;
            stroke-linejoin: round;
            mix-blend-mode: normal; /* Kein Blending, damit sie gut sichtbar sind */
        }

        /* Limes: Klar definiert */
        .limes-style {
            stroke: #3f3f46;
            opacity: 0.8;
            stroke-linecap: square;
        }
        
        /* NEU: Reichsteilungslinie */
        .division-style {
            stroke: #7e22ce;
            opacity: 0.6;
            dash-array: 5, 10;
        }

    </style>
</head>
<body class="bg-stone-100">
    <div class="parchment-overlay"></div>

    <div id="map"></div>

    <div class="ui-layer top-0 left-0 right-0 p-4 flex flex-col md:flex-row justify-between items-start gap-3 pointer-events-none">
        <div class="ui-element inline-block bg-white/95 backdrop-blur shadow-lg rounded-lg px-4 py-3 border-l-4 border-amber-600 pointer-events-auto">
            <h1 class="text-lg font-serif font-bold text-stone-800 leading-none flex items-center gap-2">
                <i class="ph-fill ph-globe-hemisphere-east text-amber-600"></i> Völkerwanderung
            </h1>
            <p class="text-xs text-stone-500 font-mono mt-1">ca. 375 – 568 n. Chr.</p>
        </div>

        <div id="narrative-alert" class="hidden ui-element mx-auto md:absolute md:left-1/2 md:-translate-x-1/2 md:top-4 transition-all duration-500 z-[5000]">
            <button id="alert-btn" onclick="askGeminiEvent()" class="alert-base px-6 py-3 rounded-full flex items-center gap-3 text-sm font-bold cursor-pointer hover:scale-105 transition-transform min-w-[280px] justify-between">
                <div class="flex items-center gap-3">
                    <i id="alert-icon" class="ph-fill text-xl"></i>
                    <div class="text-left leading-tight">
                        <span id="alert-type" class="block text-[10px] opacity-90 uppercase tracking-widest font-sans"></span>
                        <span id="alert-title" class="block text-base font-serif tracking-wide"></span>
                    </div>
                </div>
                <div class="bg-white/20 rounded-full p-1"><i class="ph-bold ph-caret-right"></i></div>
            </button>
        </div>

        <div class="ui-element flex gap-2 pointer-events-auto self-end md:self-auto">
            <button onclick="clearApiKey()" class="bg-white/90 hover:bg-white text-stone-500 border border-stone-200 px-2 py-2 rounded-lg shadow-sm flex items-center gap-2 text-xs" title="API Key löschen">
                <i class="ph-bold ph-key"></i>
            </button>
            <button onclick="askGeminiContext()" class="md:hidden bg-white text-purple-700 border border-purple-200 px-3 py-2 rounded-lg shadow-lg flex items-center gap-2 text-sm font-bold">
                <i class="ph-fill ph-sparkle"></i> Zeitgeist
            </button>
        </div>
    </div>

    <div id="key-modal" class="hidden fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 ui-element">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 border border-stone-200">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="ph-fill ph-key text-purple-600 text-2xl"></i>
                </div>
                <h2 class="font-serif font-bold text-xl text-stone-800">Setup: KI-Verbindung</h2>
                <p class="text-sm text-stone-500 mt-2">Geben Sie Ihren neuen API-Key ein. Er wird nur lokal gespeichert.</p>
            </div>
            <input type="password" id="api-key-input" placeholder="Key einfügen (AIzaSy...)" class="w-full p-3 border border-stone-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-500 focus:outline-none font-mono text-sm">
            <button onclick="saveApiKey()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-colors">Speichern & Starten</button>
        </div>
    </div>

    <div id="info-box" class="hidden ui-layer top-20 left-4 right-4 md:left-auto md:right-4 md:w-[400px] max-h-[75vh] flex flex-col rounded-xl shadow-2xl z-[4000] bg-white border border-stone-300 pointer-events-auto">
        <div id="info-artifact-container" class="relative w-full h-48 bg-stone-100 shrink-0 border-b border-stone-200">
            <img id="artifact-img" src="" alt="Artefakt" class="w-full h-full object-contain p-4">
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-white via-white/80 to-transparent p-2 pt-8">
                 <div class="flex items-center gap-2 text-amber-700 px-2">
                    <i class="ph-fill ph-bank"></i>
                    <span class="text-[10px] font-bold uppercase tracking-wider">Historisches Objekt</span>
                </div>
            </div>
        </div>
        <div class="p-5 overflow-y-auto">
            <div class="flex justify-between items-start mb-2">
                <h2 id="info-title" class="font-serif font-bold text-2xl text-stone-800"></h2>
                <button onclick="closeInfo()" class="p-1 hover:bg-stone-100 rounded-full text-stone-500 hover:text-red-600"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <h3 id="artifact-title" class="text-sm font-bold text-stone-800 mb-1"></h3>
            <p id="artifact-desc" class="text-xs text-stone-500 italic border-b border-stone-200 pb-3 mb-3 leading-relaxed"></p>
            <div id="info-quote" class="hidden mb-4 pl-3 border-l-4 border-stone-300 italic text-stone-700 font-serif text-sm bg-stone-50 p-3 rounded-r"></div>
            <div id="info-content" class="text-sm text-stone-700 leading-relaxed mb-2"></div>
            </div>
        <div id="tribe-ai-section" class="p-3 border-t border-stone-100 bg-stone-50 rounded-b-xl">
            <button onclick="askGeminiTribe()" id="tribe-ai-btn" class="w-full bg-white hover:bg-purple-50 border border-purple-200 text-purple-900 px-4 py-3 rounded-lg flex items-center justify-center gap-2 text-xs font-bold transition-all shadow-sm hover:shadow cursor-pointer">
                <i class="ph-fill ph-sparkle text-purple-600 text-lg"></i>
                <span id="tribe-ai-text">KI-Analyse: Situation im Jahr <span id="tribe-ai-year">...</span></span>
            </button>
        </div>
    </div>

    <div id="ai-modal" class="hidden fixed inset-0 z-[5000] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 ui-element">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh] overflow-hidden">
            <div class="bg-stone-900 p-4 text-white flex justify-between items-center shrink-0">
                <h3 class="font-serif font-bold flex items-center gap-2 text-lg">
                    <i class="ph-fill ph-chat-centered-text text-purple-400"></i> 
                    Historischer Diskurs: <span id="ai-modal-year" class="text-amber-400"></span>
                </h3>
                <button onclick="closeAiModal()" class="hover:bg-white/20 rounded-full p-1"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div id="ai-chat-container" class="flex-1 p-6 overflow-y-auto bg-stone-50 text-stone-800 text-base leading-relaxed space-y-4"></div>

            <div id="ai-input-area" class="hidden p-4 bg-white border-t border-stone-200 shrink-0">
                <div class="flex gap-2">
                    <input type="text" id="follow-up-input" placeholder="Stellen Sie eine Nachfrage..." class="flex-1 border border-stone-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 outline-none font-serif" onkeypress="if(event.key === 'Enter') sendFollowUp()">
                    <button onclick="sendFollowUp()" class="bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded-lg font-bold transition-colors"><i class="ph-fill ph-paper-plane-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="ui-layer bottom-0 left-0 right-0">
        <div class="ui-element bg-white border-t border-stone-200 shadow-lg p-4 pb-8 md:pb-6">
            <div class="max-w-5xl mx-auto w-full">
                
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-4">
                        <button id="play-btn" onclick="togglePlay()" class="w-14 h-14 bg-stone-800 hover:bg-stone-700 text-white rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                            <i id="play-icon" class="ph-fill ph-play text-2xl ml-1"></i>
                        </button>
                        
                        <div>
                            <div class="text-[10px] uppercase tracking-widest text-stone-500 font-bold">Jahr</div>
                            <div class="text-4xl font-serif font-bold text-stone-800 tabular-nums" id="year-display">375</div>
                        </div>

                        <div class="hidden md:flex items-center ml-4 bg-stone-100 rounded-lg p-1 border border-stone-200">
                            <button onclick="setSpeed('slow')" id="speed-slow" class="px-3 py-1 text-xs font-bold rounded-md transition-colors bg-white shadow-sm text-black">Langsam</button>
                            <button onclick="setSpeed('medium')" id="speed-medium" class="px-3 py-1 text-xs font-bold rounded-md transition-colors text-stone-600 hover:bg-white">Mittel</button>
                            <button onclick="setSpeed('fast')" id="speed-fast" class="px-3 py-1 text-xs font-bold rounded-md transition-colors text-stone-600 hover:bg-white">Schnell</button>
                        </div>
                    </div>

                    <button onclick="askGeminiContext()" class="hidden md:flex bg-purple-50 border border-purple-200 text-purple-900 hover:bg-purple-100 px-4 py-2 rounded-full shadow-sm items-center gap-2 text-xs font-bold transition-all active:scale-95">
                        <i class="ph-fill ph-sparkle text-purple-600 text-lg"></i> 
                        <div class="flex flex-col items-start leading-tight"><span>Historische Lage</span><span class="text-[10px] opacity-70">Analysiere <span id="ai-btn-year-ref">375</span></span></div>
                    </button>
                </div>

                <div class="hidden md:flex gap-3 text-[10px] font-medium text-stone-500 flex-wrap mb-2">
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-red-600 rounded-full"></div>Westgoten</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-blue-600 rounded-full"></div>Vandalen</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-green-600 rounded-full"></div>Hunnen</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-orange-600 rounded-full"></div>Langobarden</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-purple-600 rounded-full"></div>Franken</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 bg-rose-800 rounded-full"></div>Ostgoten</div>
                    <div class="flex items-center gap-1 border-l pl-2 border-stone-300 text-amber-700"><i class="ph-fill ph-scales"></i> Recht</div>
                    <div class="flex items-center gap-1 border-l pl-2 border-stone-300 text-stone-800 font-bold"><i class="ph-bold ph-road-horizon"></i> Römerstraßen</div>
                </div>

                <div class="relative px-2">
                    <input type="range" id="year-slider" min="375" max="568" value="375" step="0.1" oninput="updateYear(this.value)" onchange="updateYear(this.value)">
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const apiKey = ""; 
        let currentTribeForAI = null;
        let map;
        const layers = {};
        const eventMarkers = {};
        const cityMarkers = {};
        let climateLayer = null, plagueLayer = null, droughtLayer = null;
        let isPlaying = false;
        let animationInterval;
        let currentYear = 375;
        let activeAlertEvent = null;
        let chatContext = []; 
        const speedConfig = { slow: 0.15, medium: 0.5, fast: 1.2 };
        let yearStep = speedConfig.slow; 
        let empireDivisionLine = null; // Referenz für die Teilungslinie

        // --- GEO-DATEN ---
        
        const limesPath = [ [52.18, 4.41], [52.05, 5.10], [51.87, 5.80], [51.60, 6.20], [51.20, 6.80], [50.93, 6.96], [50.36, 7.60], [50.00, 8.20], [49.97, 8.90], [50.18, 8.95], [50.50, 9.50], [49.80, 10.90], [48.90, 11.50], [48.90, 12.00], [48.50, 13.50], [48.30, 14.30], [48.10, 16.40], [47.80, 17.60], [47.80, 19.00], [44.80, 20.40], [44.60, 22.60], [45.20, 29.60] ];
        
        // Die Diokletianisch-Theodosianische Teilungslinie (ca. 395 n.Chr.)
        const divisionPath = [ [45.0, 19.5], [44.0, 19.0], [42.5, 18.5], [42.0, 19.0], [41.0, 19.5], [39.0, 19.8], [35.0, 20.0], [32.0, 20.0] ];

        const strategicRivers = {
            rhein: [[46.6, 9.3], [47.0, 9.5], [47.5, 9.6], [47.6, 9.4], [47.5, 8.5], [47.5, 7.6], [48.0, 7.6], [48.6, 7.9], [49.0, 8.4], [50.0, 8.2], [50.4, 7.5], [50.9, 7.0], [51.2, 6.8], [51.5, 6.5], [51.9, 5.0]],
            donau: [[48.0, 8.1], [48.4, 10.0], [48.5, 12.0], [48.3, 14.0], [48.2, 16.4], [47.8, 17.5], [47.7, 18.5], [47.5, 19.0], [45.5, 19.5], [44.8, 20.4], [44.5, 21.5], [44.2, 22.7], [43.8, 24.5], [44.2, 26.0], [45.2, 29.0]],
            // NEU: Die Elbe (Herkunft der Langobarden)
            elbe: [[53.9, 8.7], [53.5, 9.5], [53.4, 10.5], [52.5, 11.5], [52.0, 12.0], [51.8, 12.5], [51.0, 13.0], [50.5, 14.0], [50.0, 15.0]],
            rhone: [[46.5, 8.3], [46.3, 7.0], [46.2, 6.0], [45.7, 5.0], [45.7, 4.8], [45.0, 4.8], [44.5, 4.7], [43.5, 4.7]],
            po: [[44.7, 7.0], [45.1, 9.0], [45.0, 10.0], [44.9, 11.5], [44.9, 12.5]],
            nil: [[31.2, 30.0], [30.0, 31.2], [28.0, 30.8], [26.0, 32.0], [24.0, 32.8]]
        };

        const historicalRegions = [ { c: [46.5, 2.0], t: "GALLIA", s: 16 }, { c: [40.0, -4.0], t: "HISPANIA", s: 16 }, { c: [42.5, 12.5], t: "ITALIA", s: 16 }, { c: [45.0, 17.0], t: "PANNONIA", s: 14 }, { c: [43.0, 22.0], t: "ILLYRICUM", s: 14 }, { c: [42.0, 25.0], t: "THRACIA", s: 14 }, { c: [35.0, 2.0], t: "AFRICA", s: 16 }, { c: [51.0, 10.0], t: "GERMANIA", s: 16, color: "#a8a29e" }, { c: [48.0, 30.0], t: "SCYTHIA", s: 14, color: "#a8a29e" } ];
        const dynamicCities = [ { c: [41.9, 12.5], t: "Rom", type: 'capital', start: 0, end: 600 }, { c: [41.0, 28.9], t: "Konstantinopel", type: 'capital', start: 330, end: 600 }, { c: [36.8, 10.1], t: "Karthago", type: 'city', start: 0, end: 600 }, { c: [44.4, 12.2], t: "Ravenna", type: 'capital', start: 402, end: 600 }, { c: [43.6, 1.4], t: "Tolosa", type: 'barbarian', start: 418, end: 507 }, { c: [39.8, -4.0], t: "Toledo", type: 'barbarian', start: 507, end: 600 }, { c: [41.5, 13.8], t: "Monte Cassino", type: 'monastery', start: 529, end: 600 } ];
        
        const romanRoads = {
            viaAppia: { name: "Via Appia", path: [[41.9, 12.5], [41.5, 12.9], [41.2, 13.5], [41.1, 14.2], [41.1, 14.8], [40.8, 15.5], [40.6, 17.9]], region: 'west' }, 
            viaDomitia: { name: "Via Domitia", path: [[45.0, 6.7], [44.5, 6.0], [43.8, 4.8], [43.6, 4.0], [43.2, 3.2], [42.4, 2.9]], region: 'west' },   
            viaEgnatia: { name: "Via Egnatia", path: [[41.3, 19.4], [41.0, 20.5], [40.7, 21.5], [40.9, 23.5], [40.9, 25.0], [41.0, 28.9]], region: 'east' }, 
            viaAgrippa: { name: "Via Agrippa", path: [[43.6, 4.6], [44.9, 4.8], [45.7, 4.8], [46.5, 4.9], [47.3, 5.0], [48.2, 5.5], [49.8, 6.6], [50.9, 6.9]], region: 'west' }     
        };

        const culturalEvents = [
            { year: 325, lat: 40.4, lng: 29.7, title: "Konzil von Nicäa", type: "religion", icon: "ph-cross", desc: "Definition des katholischen Glaubens.", prompt: "Erkläre den Konflikt Arianismus vs Katholizismus." },
            { year: 380, lat: 41.0, lng: 28.9, title: "Edikt Cunctos populos", type: "religion", icon: "ph-scroll", desc: "Theodosius I. macht das Christentum zur Staatsreligion.", prompt: "Analysiere das Edikt von Thessaloniki rechtshistorisch." },
            { year: 395, lat: 42.5, lng: 19.5, title: "Reichsteilung", type: "treaty", icon: "ph-arrows-split", desc: "Tod Theodosius I. Endgültige Trennung in West- und Ostrom.", prompt: "Welche staatsrechtlichen und administrativen Folgen hatte die Teilung 395?" }, // NEU
            { year: 438, lat: 41.0, lng: 28.9, title: "Codex Theodosianus", type: "law", icon: "ph-scales", desc: "Erste offizielle Gesetzessammlung seit den Zwölftafeln.", prompt: "Welche Bedeutung hat der Codex Theodosianus für die Rechtseinheit?" },
            { year: 475, lat: 43.6, lng: 1.4, title: "Codex Euricianus", type: "law", icon: "ph-book-bookmark", desc: "Westgotisches Volksrecht.", prompt: "Analysiere den Codex Euricianus." },
            { year: 506, lat: 43.6, lng: 1.4, title: "Breviarium Alaricianum", type: "law", icon: "ph-scales", desc: "Lex Romana Visigothorum.", prompt: "Erkläre das Personalitätsprinzip." },
            { year: 507, lat: 48.8, lng: 2.3, title: "Lex Salica", type: "law", icon: "ph-gavel", desc: "Das Recht der salischen Franken.", prompt: "Was regelt die Lex Salica?" },
            { year: 529, lat: 41.0, lng: 28.9, title: "Codex Justinianus", type: "law", icon: "ph-bank", desc: "Basis des Corpus Iuris Civilis.", prompt: "Warum ist der Codex Justinianus für die heutige Zivilistik wichtig?" },
            { year: 529, lat: 41.5, lng: 13.8, title: "Regula Benedicti", type: "religion", icon: "ph-church", desc: "Gründung von Monte Cassino.", prompt: "Wie bewahrten die Klöster die antike Bildung?" }
        ];

        const routes = {
            westgoten: { name: "Westgoten", color: "#dc2626", desc: "Foederati, dann Tolosanisches Reich.", path: [[45.5, 25.0, 375], [41.6, 26.5, 378], [40.6, 22.9, 395], [41.9, 12.5, 410], [43.6, 1.4, 418], [41.6, -4.7, 470], [39.8, -4.0, 507]], artifact: { img: localImages.westgoten, fallback: artifacts.westgoten, title: "Adlerfibel", text: "Meisterwerk der Cloisonné-Technik." } },
            vandalen: { name: "Vandalen", color: "#2563eb", desc: "Zug nach Karthago, Seemacht.", path: [[51.0, 17.0, 375], [50.0, 8.2, 405], [49.9, 8.2, 406], [44.8, -0.5, 409], [37.3, -5.9, 415], [35.9, -5.6, 429], [36.8, 10.1, 439], [41.9, 12.5, 455], [36.8, 10.1, 460]], artifact: { img: localImages.vandalen, fallback: artifacts.vandalen, title: "Siliqua des Gelimer", text: "Vandalische Silbermünze." } },
            hunnen: { name: "Hunnen", color: "#16a34a", desc: "Reiternomaden, 'Geißel Gottes'.", path: [[48.0, 43.0, 375], [47.0, 30.0, 390], [47.5, 19.0, 405], [49.0, 4.0, 451], [45.4, 10.9, 452], [47.5, 19.0, 453]], artifact: { img: localImages.hunnen, fallback: artifacts.hunnen, title: "Zikadenfibel", text: "Symbol der Wiedergeburt." } },
            langobarden: { name: "Langobarden", color: "#d97706", desc: "Späte Einwanderung nach Italien.", path: [[53.5, 10.5, 375], [53.5, 10.5, 400], [48.5, 16.5, 489], [47.5, 19.0, 526], [46.0, 13.0, 568], [45.4, 9.1, 572]], artifact: { img: localImages.langobarden, fallback: artifacts.langobarden, title: "Goldblattkreuz", text: "Langobardische Grabbeigabe." } },
            franken: { name: "Franken", color: "#9333ea", desc: "Expansion vom Rhein nach Gallien.", path: [[51.5, 5.0, 375], [51.0, 4.5, 430], [50.0, 3.5, 451], [49.4, 3.3, 486], [48.8, 2.3, 500], [46.5, 0.5, 507], [48.8, 2.3, 511]], artifact: { img: localImages.franken, fallback: artifacts.franken, title: "Goldbiene", text: "Aus dem Grab Childerichs." } },
            ostgoten: { name: "Ostgoten", color: "#9f1239", desc: "Zug nach Italien (489).", path: [[47.0, 32.0, 375], [46.5, 29.0, 400], [47.5, 19.0, 454], [46.0, 14.5, 488], [45.4, 11.0, 489], [44.4, 12.2, 493], [44.4, 12.2, 526]], artifact: { img: localImages.ostgoten, fallback: artifacts.ostgoten, title: "Adlerfibel", text: "Ostgotische Goldschmiedekunst." } },
            stilicho: { name: "Legionen (Stilicho)", color: "#7e22ce", type: "army", desc: "401: Stilicho zieht Truppen von der Rheingrenze ab.", path: [[50.0, 8.2, 401], [47.5, 7.5, 401.5], [45.4, 9.2, 402]], artifact: { img: localImages.rom, fallback: artifacts.rom, title: "Schildzeichen (Chi-Rho)", text: "Das Christusmonogramm auf den Schilden." } },
            aetius: { name: "Heer des Aetius", color: "#7e22ce", type: "army", desc: "451: Aetius mobilisiert gegen Attila.", path: [[41.9, 12.5, 450], [45.0, 5.0, 450.5], [49.0, 4.0, 451]], artifact: { img: localImages.rom, fallback: artifacts.rom, title: "Schildzeichen (Chi-Rho)", text: "Symbol des christlichen Imperiums." } },
            belisarius: { name: "Flotte (Belisar)", color: "#7e22ce", type: "army", desc: "533: Oströmische Rückeroberung.", path: [[41.0, 28.9, 533], [37.0, 15.0, 533.4], [36.8, 10.1, 533.8], [37.5, 14.0, 535], [41.9, 12.5, 536], [44.4, 12.2, 540]], artifact: { img: localImages.rom, fallback: artifacts.rom, title: "Schildzeichen (Chi-Rho)", text: "Symbol der Restauratio Imperii." } },
            pest: { name: "Die Pest", color: "#10b981", type: "plague", desc: "541-545: Yersinia pestis breitet sich aus.", path: [[31.0, 32.5, 541], [31.2, 29.9, 541.5], [41.0, 28.9, 542], [38.0, 23.0, 542.5], [37.5, 15.0, 543], [41.9, 12.5, 543.5], [43.3, 5.4, 544], [48.0, 2.0, 545]], artifact: { img: localImages.pest, fallback: artifacts.pest, title: "Yersinia pestis", text: "Der Erreger der Beulenpest." } }
        };
        
        const historicalEvents = [ 
            { year: 375, lat: 48.0, lng: 45.0, title: "Megadürre", type: "climate", icon: "ph-sun-dim", duration: 25, desc: "Jahrzehntelange Trockenheit.", quote: "Die Steppe verdorrte." },
            { year: 378, lat: 41.67, lng: 26.56, title: "Schlacht von Adrianopel", type: "battle", desc: "Goten besiegen Valens.", quote: "Ein Gemetzel wie bei Cannae." }, 
            { year: 401, lat: 45.4, lng: 9.2, title: "Alarichs Einfall", type: "move", desc: "Goten fallen in Italien ein.", quote: "Die Mauern erzittern." },
            { year: 406, lat: 49.9, lng: 8.2, title: "Rheinübergang", type: "move", desc: "Vandalen & Sueben brechen durch.", quote: "Ganz Gallien rauchte." }, 
            { year: 410, lat: 41.9, lng: 12.5, title: "Plünderung Roms", type: "battle", desc: "Alarich in Rom.", quote: "Die Stadt ist erobert." }, 
            { year: 429, lat: 35.9, lng: -5.6, title: "Zug nach Afrika", type: "move", desc: "Vandalen setzen über.", quote: "Das Brot geht aus." },
            { year: 447, lat: 41.0, lng: 28.0, title: "Hunnen-Tribut", type: "diplomacy", desc: "Ostrom erkauft Frieden.", quote: "Gold statt Blut." },
            { year: 451, lat: 49.0, lng: 4.0, title: "Katalaunische Felder", type: "battle", desc: "Aetius stoppt Attila.", quote: "Ein wilder Kampf." }, 
            { year: 455, lat: 41.9, lng: 12.5, title: "Sack von Rom", type: "battle", desc: "Vandalen plündern Rom.", quote: null }, 
            { year: 476, lat: 44.4, lng: 12.2, title: "Ende Westroms", type: "treaty", desc: "Odoaker setzt den letzten Kaiser ab.", quote: "Kein Kaiser mehr im Westen." }, 
            { year: 486, lat: 49.3, lng: 3.3, title: "Schlacht von Soissons", type: "battle", desc: "Chlodwig besiegt Syagrius.", quote: "Ende Roms in Gallien." }, 
            { year: 493, lat: 44.4, lng: 12.2, title: "Rabenschlacht", type: "treaty", desc: "Theoderich tötet Odoaker.", quote: "Der Verrat von Ravenna." },
            { year: 507, lat: 46.5, lng: 0.5, title: "Schlacht von Vouillé", type: "battle", desc: "Franken besiegen Westgoten.", quote: "Die Goten weichen nach Spanien." },
            { year: 533, lat: 36.8, lng: 10.1, title: "Vandalenkrieg", type: "battle", desc: "Belisar landet in Afrika.", quote: "Justinians Traum." },
            { year: 536, lat: 42.0, lng: 12.5, title: "Vulkanischer Winter", type: "climate", icon: "ph-snowflake", duration: 10, desc: "Ein Jahr ohne Sommer.", quote: "Die Sonne gab ihr Licht ohne Strahl." },
            { year: 540, lat: 36.2, lng: 36.1, title: "Perserkrieg", type: "crisis", desc: "Sassaniden plündern Antiochia.", quote: "Die zweite Front." },
            { year: 542, lat: 41.0, lng: 28.9, title: "Justinianische Pest", type: "plague", icon: "ph-skull", duration: 20, desc: "Pandemie tötet Millionen.", quote: "Gottes Zorn." },
            { year: 552, lat: 43.2, lng: 12.8, title: "Busta Gallorum", type: "battle", desc: "Ende der Ostgoten.", quote: "Ein blutiges Ende." }
        ];

        window.onload = function() { getApiKey(); initMap(); updateVisualization(375); };

        function setSpeed(level) {
            yearStep = speedConfig[level]; 
            document.querySelectorAll('[id^="speed-"]').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-black');
                btn.classList.add('text-stone-600', 'hover:bg-white');
            });
            const activeBtn = document.getElementById(`speed-${level}`);
            activeBtn.classList.add('bg-white', 'shadow-sm', 'text-black');
            activeBtn.classList.remove('text-stone-600');
        }

        function initMap() {
            // Relief Map für Geografie (Originalfarben)
            map = L.map('map', { zoomControl: true, attributionControl: false, zoomSnap: 0.25, zoomDelta: 0.25 }).setView([46.5, 14.0], 5);
            map.zoomControl.setPosition('topright'); 

            // Esri World Shaded Relief
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', { 
                attribution: 'Esri', opacity: 0.8 
            }).addTo(map);

            // FLÜSSE ZEICHNEN
            Object.values(strategicRivers).forEach(riverPath => {
                L.polyline(riverPath, { 
                    className: 'river-style', 
                    weight: 2, 
                    opacity: 0.7,
                    smoothFactor: 1 
                }).addTo(map);
            });

            // LIMES (Grenze)
            const limes = L.polyline(limesPath, { 
                className: 'limes-style',
                weight: 2, 
                dashArray: '4, 4', 
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(map);
            limes.bindTooltip("Limes Germanicus", { sticky: true, className: 'leaflet-tooltip custom-label', direction: 'top' });
            
            // REICHSTEILUNGSLINIE (Initial unsichtbar)
            empireDivisionLine = L.polyline(divisionPath, {
                color: '#7e22ce',
                weight: 2,
                dashArray: '10, 5',
                opacity: 0
            }).addTo(map);
            empireDivisionLine.bindTooltip("Teilungslinie (395 n. Chr.)", { sticky: true, className: 'leaflet-tooltip custom-label', direction: 'top' });

            // RÖMERSTRASSEN
            Object.keys(romanRoads).forEach(key => {
                const road = romanRoads[key];
                road.line = L.polyline(road.path, { 
                    color: '#5c4d3c', 
                    weight: 3, 
                    opacity: 0.6,
                    smoothFactor: 1, 
                    className: 'road-relief' 
                }).addTo(map);
                road.line.bindTooltip(road.name, { sticky: true, className: 'leaflet-tooltip custom-label' });
            });

            historicalRegions.forEach(reg => {
                const color = reg.color || '#44403c';
                L.tooltip({ permanent: true, direction: 'center', className: 'region-label', opacity: 0.8 }).setContent(`<span style="font-size:${reg.s}px; color:${color}">${reg.t}</span>`).setLatLng(reg.c).addTo(map);
            });

            dynamicCities.forEach((city, idx) => {
                let color = '#666'; if (city.type === 'capital') color = '#7e22ce'; if (city.type === 'barbarian') color = '#d97706'; if (city.type === 'monastery') color = '#0ea5e9'; 
                const marker = L.circleMarker(city.c, { radius: 4, color: color, fillColor: '#fff', fillOpacity: 1, weight: 2, opacity: 0 }).addTo(map);
                const tooltip = L.tooltip({ permanent: true, direction: 'bottom', className: 'bg-transparent border-0 shadow-none text-stone-700 font-serif text-[10px] uppercase tracking-wider font-bold', offset: [0, 5], opacity: 0 }).setContent(city.t).setLatLng(city.c).addTo(map);
                cityMarkers[idx] = { marker, tooltip, start: city.start, end: city.end };
            });

            climateLayer = L.circle([46.0, 15.0], { radius: 1500000, color: '#64748b', fillColor: '#94a3b8', fillOpacity: 0, opacity: 0, weight: 0 }).addTo(map);
            plagueLayer = L.circle([38.0, 18.0], { radius: 1500000, color: '#10b981', fillColor: '#10b981', fillOpacity: 0, opacity: 0, weight: 0 }).addTo(map);
            droughtLayer = L.circle([48.0, 40.0], { radius: 800000, color: '#d97706', fillColor: '#d97706', fillOpacity: 0, opacity: 0, weight: 0 }).addTo(map);

            Object.keys(routes).forEach(key => {
                const data = routes[key];
                let dashStyle = '1, 6'; if (data.type === 'army') dashStyle = '10, 5'; if (data.type === 'plague') dashStyle = '1, 10'; 
                const line = L.polyline([], { color: data.color, weight: 4, opacity: 0.8, dashArray: dashStyle }).addTo(map);
                let borderRadius = '50%'; if (data.type === 'army') borderRadius = '2px';
                let iconClass = 'pulse-icon'; if (data.type === 'army') iconClass = 'pulse-icon roman-pulse'; if (data.type === 'plague') iconClass = 'pulse-icon plague-pulse';
                const iconHtml = `<div style="background-color: ${data.color}; width: 14px; height: 14px; border-radius: ${borderRadius}; border: 2px solid white;"></div>`;
                const icon = L.divIcon({ className: iconClass, html: iconHtml, iconSize: [14, 14], iconAnchor: [7, 7] });
                const marker = L.marker([0,0], { icon: icon }).addTo(map);
                marker.bindTooltip(data.name, { permanent: true, direction: 'right', className: 'custom-label', offset: [10, 0] });
                marker.on('click', () => showInfo(data.name, data.desc, null, data.color, key, data.artifact));
                layers[key] = { line, marker, hasStarted: false };
            });

            historicalEvents.forEach(ev => {
                const color = (ev.type === 'battle' || ev.type === 'crisis' || ev.type === 'plague') ? '#dc2626' : (ev.type === 'climate' ? '#06b6d4' : '#4b5563');
                let iconType = ev.icon || (ev.type === 'battle' ? 'ph-swords' : (ev.type === 'plague' ? 'ph-skull' : (ev.type === 'crisis' ? 'ph-fire' : (ev.type === 'diplomacy' ? 'ph-handshake' : 'ph-snowflake'))));
                const pulseClass = ev.type === 'climate' || ev.type === 'plague' ? 'climate-pulse' : '';
                const html = `<div class="battle-marker flex items-center justify-center w-8 h-8 bg-white rounded-full shadow-md border border-stone-200 text-[${color}] ${pulseClass}"><i class="ph-fill ${iconType} text-lg" style="color:${color}"></i></div>`;
                const icon = L.divIcon({ className: 'bg-transparent', html: html, iconSize: [32, 32], iconAnchor: [16, 16] });
                const marker = L.marker([ev.lat, ev.lng], { icon: icon, opacity: 0 }).addTo(map);
                marker.on('click', () => showInfo(ev.title, ev.desc, ev.quote, color, null, null));
                eventMarkers[ev.year] = marker;
            });

            culturalEvents.forEach(ev => {
                const html = `<div class="culture-marker flex items-center justify-center w-8 h-8 rounded-full text-amber-700 bg-amber-50"><i class="ph-fill ${ev.icon} text-lg"></i></div>`;
                const icon = L.divIcon({ className: 'bg-transparent', html: html, iconSize: [32, 32], iconAnchor: [16, 16] });
                const marker = L.marker([ev.lat, ev.lng], { icon: icon, opacity: 0 }).addTo(map);
                marker.on('click', () => {
                    activeAlertEvent = { title: ev.title, year: ev.year, desc: ev.desc, aiPrompt: ev.prompt, type: ev.type };
                    askGeminiEvent(); 
                });
                eventMarkers['cult_' + ev.year + ev.title] = { marker: marker, data: ev };
            });
        }

        function getPosition(path, year) {
            if (year < path[0][2]) return null;
            if (year >= path[path.length - 1][2]) return { lat: path[path.length-1][0], lng: path[path.length-1][1], trail: path.map(p => [p[0], p[1]]) };
            for (let i = 0; i < path.length - 1; i++) {
                if (year >= path[i][2] && year < path[i+1][2]) {
                    const f = (year - path[i][2]) / (path[i+1][2] - path[i][2]);
                    return { lat: path[i][0] + (path[i+1][0] - path[i][0]) * f, lng: path[i][1] + (path[i+1][1] - path[i][1]) * f, trail: [...path.slice(0, i+1).map(p=>[p[0],p[1]]), [path[i][0] + (path[i+1][0] - path[i][0]) * f, path[i][1] + (path[i+1][1] - path[i][1]) * f]] };
                }
            }
            return null;
        }

        function updateVisualization(year) {
            currentYear = year;
            const aiYearEl = document.getElementById('tribe-ai-year'); if (aiYearEl) aiYearEl.innerText = Math.floor(year);
            const aiBtnRef = document.getElementById('ai-btn-year-ref'); if (aiBtnRef) aiBtnRef.innerText = Math.floor(year);
            
            Object.values(cityMarkers).forEach(cm => {
                if (year >= cm.start && year <= cm.end) { cm.marker.setStyle({ opacity: 1, fillOpacity: 1 }); cm.tooltip.setOpacity(1); } else { cm.marker.setStyle({ opacity: 0, fillOpacity: 0 }); cm.tooltip.setOpacity(0); }
            });

            // Empire Division Line visibility
            if (empireDivisionLine) {
                if (year >= 395) { empireDivisionLine.setStyle({opacity: 0.7}); } 
                else { empireDivisionLine.setStyle({opacity: 0}); }
            }

            // Road Decay Logic
            Object.values(romanRoads).forEach(road => {
                let opacity = 0.6;
                let dashArray = null;
                if (road.region === 'west') {
                    if (year > 410) { opacity = 0.5; }
                    if (year > 455) { opacity = 0.3; dashArray = '5, 10'; }
                    if (year > 500) { opacity = 0.2; }
                } else { if (year > 550) opacity = 0.6; }
                road.line.setStyle({ opacity: opacity, dashArray: dashArray });
            });

            // Alerts
            const alertDiv = document.getElementById('narrative-alert');
            const alertBtn = document.getElementById('alert-btn');
            const alertIcon = document.getElementById('alert-icon');
            const alertType = document.getElementById('alert-type');
            const alertTitle = document.getElementById('alert-title');
            
            if (year >= 370 && year <= 400) { let op = 0.3; if(year < 375) op = (year - 370) * 0.06; if(year > 385) op = 0.3 - ((year - 385) * 0.02); droughtLayer.setStyle({ fillOpacity: Math.max(0, op), opacity: 0 }); } else { droughtLayer.setStyle({ fillOpacity: 0 }); }
            if (year >= 536 && year <= 545) { let op = 0.3; if(year > 538) op = 0.3 - ((year - 538) * 0.04); climateLayer.setStyle({ fillOpacity: Math.max(0, op), opacity: 0 }); } else { climateLayer.setStyle({ fillOpacity: 0 }); }
            if (year >= 541 && year <= 560) { let op = 0.3; if(year > 545) op = 0.3 - ((year - 545) * 0.02); plagueLayer.setStyle({ fillOpacity: Math.max(0, op), opacity: 0 }); } else { plagueLayer.setStyle({ fillOpacity: 0 }); }

            let currentEvents = historicalEvents.filter(ev => year >= ev.year && year <= (ev.year + (ev.duration || 2)));
            if (currentEvents.length > 0) {
                currentEvents.sort((a, b) => { const p = { 'plague': 3, 'climate': 3, 'crisis': 3, 'battle': 2, 'move': 2, 'treaty': 1 }; return (p[b.type] || 0) - (p[a.type] || 0); });
                let ev = currentEvents[0];
                let btnClass = 'alert-base'; let icon = 'ph-info'; let typeText = 'Ereignis';
                if (ev.type === 'battle') { btnClass += ' alert-battle'; icon = 'ph-swords'; typeText = 'Militärischer Konflikt'; }
                else if (ev.type === 'treaty' || ev.type === 'diplomacy') { btnClass += ' alert-treaty'; icon = 'ph-scroll'; typeText = 'Politische Zäsur'; }
                else if (ev.type === 'move') { btnClass += ' alert-move'; icon = 'ph-arrows-left-right'; typeText = 'Migration'; }
                else if (ev.type === 'climate' || ev.type === 'drought') { 
                    if(ev.type === 'drought') { btnClass += ' alert-drought'; icon = 'ph-sun-dim'; typeText = 'Ökologische Krise'; }
                    else { btnClass += ' alert-nature'; icon = 'ph-snowflake'; typeText = 'Klima-Anomalie'; }
                }
                else if (ev.type === 'plague') { btnClass += ' alert-plague'; icon = 'ph-skull'; typeText = 'Pandemie'; }
                else if (ev.type === 'crisis') { btnClass += ' alert-battle'; icon = 'ph-fire'; typeText = 'Reichskrise'; }

                activeAlertEvent = ev; 
                alertBtn.className = btnClass;
                alertIcon.className = `ph-fill text-xl ${icon}`;
                alertType.innerText = typeText;
                alertTitle.innerText = ev.title;
                alertDiv.classList.remove('hidden');
            } else { 
                alertDiv.classList.add('hidden'); 
                activeAlertEvent = null; 
            }

            Object.keys(routes).forEach(key => {
                const res = getPosition(routes[key].path, year);
                const layerData = layers[key]; 
                if (res) {
                    if (!layerData.hasStarted) { layerData.marker.setOpacity(1); layerData.line.setStyle({opacity: 0.8}); layerData.hasStarted = true; }
                    layerData.marker.setLatLng([res.lat, res.lng]); layerData.line.setLatLngs(res.trail);
                    const isHunnenEnd = (key === 'hunnen' && year > 454);
                    const isStilichoEnd = (key === 'stilicho' && year > 408);
                    const isAetiusEnd = (key === 'aetius' && year > 454);
                    if (isHunnenEnd || isStilichoEnd || isAetiusEnd) { layerData.marker.setOpacity(0); layerData.marker.closeTooltip(); layerData.line.setStyle({opacity: 0.15}); } 
                    else { layerData.marker.setOpacity(1); if(!layerData.marker.isTooltipOpen()) layerData.marker.openTooltip(); layerData.line.setStyle({opacity: 0.8}); }
                } else { layerData.marker.setOpacity(0); layerData.marker.closeTooltip(); layerData.line.setLatLngs([]); layerData.hasStarted = false; }
            });
            
            historicalEvents.forEach(ev => {
                const marker = eventMarkers[ev.year]; if (!marker) return;
                const duration = ev.duration || 2; const endYear = ev.year + duration;
                if (year >= ev.year && year <= endYear) {
                    let opacity = 1; if (duration > 5) { opacity = 1 - ((year - ev.year) / duration * 0.8); }
                    marker.setOpacity(opacity);
                } else { marker.setOpacity(0); }
            });

            Object.keys(eventMarkers).forEach(key => {
                if (!key.startsWith('cult_')) return; 
                const obj = eventMarkers[key];
                const ev = obj.data;
                const marker = obj.marker;
                const isActive = year >= ev.year && year <= (ev.year + 25); 
                marker.setOpacity(isActive ? 1 : 0);
            });
        }

        function updateYear(val) { const y = parseFloat(val); document.getElementById('year-display').innerText = Math.floor(y); currentYear = y; updateVisualization(y); }
        
        function startAnimation() {
            animationInterval = setInterval(() => {
                let currentStep = yearStep;
                if (activeAlertEvent) { currentStep = yearStep * 0.15; }
                let preciseVal = currentYear; 
                if (preciseVal >= 568) preciseVal = 375; 
                else preciseVal += currentStep;
                document.getElementById('year-slider').value = preciseVal;
                updateYear(preciseVal);
            }, 50); 
        }

        function togglePlay() {
            const btn = document.getElementById('play-icon');
            if (isPlaying) {
                clearInterval(animationInterval);
                isPlaying = false;
                btn.classList.remove('ph-pause'); btn.classList.add('ph-play');
                btn.parentElement.classList.remove('bg-red-600'); btn.parentElement.classList.add('bg-stone-800');
            } else {
                isPlaying = true;
                btn.classList.remove('ph-play'); btn.classList.add('ph-pause');
                btn.parentElement.classList.remove('bg-stone-800'); btn.parentElement.classList.add('bg-red-600');
                startAnimation();
            }
        }

        function showInfo(title, text, quote, color, key, artifact) {
            currentTribeForAI = key ? { name: title, key: key } : null;
            const box = document.getElementById('info-box');
            const artContainer = document.getElementById('info-artifact-container');
            const aiSection = document.getElementById('tribe-ai-section');

            document.getElementById('info-title').innerText = title; document.getElementById('info-title').style.color = color;
            document.getElementById('info-content').innerText = text;

            if (artifact) {
                artContainer.classList.remove('hidden');
                const img = document.getElementById('artifact-img');
                img.onerror = function() { this.onerror = null; this.src = artifact.fallback; };
                img.src = artifact.img;
                document.getElementById('artifact-title').innerText = artifact.title;
                document.getElementById('artifact-desc').innerText = artifact.text;
                document.getElementById('artifact-desc').classList.remove('hidden');
            } else { artContainer.classList.add('hidden'); document.getElementById('artifact-desc').classList.add('hidden'); }

            if (quote) { document.getElementById('info-quote').innerText = quote; document.getElementById('info-quote').classList.remove('hidden'); } else { document.getElementById('info-quote').classList.add('hidden'); }
            if (key) { aiSection.classList.remove('hidden'); } else { aiSection.classList.add('hidden'); }
            
            document.getElementById('tribe-ai-response').classList.add('hidden'); document.getElementById('tribe-ai-response').innerHTML = '';
            box.classList.remove('hidden');
        }

        function closeInfo() { document.getElementById('info-box').classList.add('hidden'); }
        
        // --- CHAT & AI LOGIK (NUN UNIFIZIERT) ---

        function closeAiModal() { 
            document.getElementById('ai-modal').classList.add('hidden'); 
            chatContext = []; // Reset History
            document.getElementById('ai-input-area').classList.add('hidden');
        }

        function appendMessage(text, sender) {
            const container = document.getElementById('ai-chat-container');
            const div = document.createElement('div');
            
            if (sender === 'ai') {
                div.className = "bg-white p-4 rounded-lg border border-stone-200 shadow-sm text-stone-800";
                div.innerHTML = `<div class="font-bold text-xs text-purple-600 mb-1 uppercase tracking-wider">Historiker</div>${formatText(text)}`;
            } else {
                div.className = "bg-stone-200 p-3 rounded-lg border border-stone-300 text-stone-700 ml-12 text-right self-end"; 
                div.innerHTML = `<div class="font-bold text-xs text-stone-500 mb-1 uppercase tracking-wider">Ihre Nachfrage</div>${formatText(text)}`;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight; 
        }

        // UPDATE: Nutzt jetzt das Chat Modal statt die Sidebar!
        async function askGeminiTribe() {
            if (!currentTribeForAI) return;
            const modal = document.getElementById('ai-modal'); 
            const container = document.getElementById('ai-chat-container');
            
            document.getElementById('ai-modal-year').innerText = currentTribeForAI.name + " (" + Math.floor(currentYear) + ")"; 
            modal.classList.remove('hidden');
            container.innerHTML = ''; 
            
            container.innerHTML = `<div id="loading-spinner" class="flex flex-col items-center justify-center py-12"><div class="ai-spinner mb-4 w-8 h-8 border-t-purple-600"></div><p class="text-stone-500 italic">Analysiere Quellen zu den ${currentTribeForAI.name}...</p></div>`;

            const prompt = `Du bist ein Experte für Spätantike. Thema: Die Gruppe '${currentTribeForAI.name}' im Jahr ${Math.floor(currentYear)} n. Chr. Erkläre präzise ihre Situation (Ort, Rechtsstatus, Anführer, militärische Ziele). 2-3 Sätze, Deutsch.`;
            
            chatContext = [{ role: 'user', parts: [{ text: prompt }] }];

            const result = await callGeminiWithHistory(chatContext);
            
            document.getElementById('loading-spinner').remove();
            appendMessage(result, 'ai');
            
            chatContext.push({ role: 'model', parts: [{ text: result }] });
            document.getElementById('ai-input-area').classList.remove('hidden');
            document.getElementById('follow-up-input').focus();
        }

        async function askGeminiContext() {
            const modal = document.getElementById('ai-modal'); 
            const container = document.getElementById('ai-chat-container');
            
            document.getElementById('ai-modal-year').innerText = Math.floor(currentYear); 
            modal.classList.remove('hidden');
            container.innerHTML = ''; 
            
            container.innerHTML = `<div id="loading-spinner" class="flex flex-col items-center justify-center py-12"><div class="ai-spinner mb-4 w-8 h-8 border-t-amber-500"></div><p class="text-stone-500 italic">Analysiere Quellen...</p></div>`;

            const prompt = `Du bist ein Althistoriker. Analysiere das Jahr ${Math.floor(currentYear)} n. Chr. in Europa. Fokus: Militärische Lage (Westrom/Ostrom), Völkerwanderung, diplomatische Zäsuren. Antworte anspruchsvoll auf Deutsch.`;
            
            chatContext = [{ role: 'user', parts: [{ text: prompt }] }];

            const result = await callGeminiWithHistory(chatContext);
            
            document.getElementById('loading-spinner').remove();
            appendMessage(result, 'ai');
            
            chatContext.push({ role: 'model', parts: [{ text: result }] });
            document.getElementById('ai-input-area').classList.remove('hidden');
            document.getElementById('follow-up-input').focus();
        }

        async function askGeminiEvent() {
            if (!activeAlertEvent) return;
            const modal = document.getElementById('ai-modal'); 
            const container = document.getElementById('ai-chat-container');
            
            document.getElementById('ai-modal-year').innerText = activeAlertEvent.title; 
            modal.classList.remove('hidden');
            container.innerHTML = ''; 
            
            container.innerHTML = `<div id="loading-spinner" class="flex flex-col items-center justify-center py-12"><div class="ai-spinner mb-4 w-8 h-8 border-t-red-600"></div><p class="text-stone-500 italic">Analysiere Ereignis...</p></div>`;

            const promptText = activeAlertEvent.aiPrompt || `Analysiere das Ereignis '${activeAlertEvent.title}' im Jahr ${activeAlertEvent.year}.`;
            const prompt = `Du bist Historiker. ${promptText} Antworte präzise, analytisch und auf Deutsch.`;

            chatContext = [{ role: 'user', parts: [{ text: prompt }] }];
            
            const result = await callGeminiWithHistory(chatContext);
            
            document.getElementById('loading-spinner').remove();
            appendMessage(result, 'ai');
            
            chatContext.push({ role: 'model', parts: [{ text: result }] });
            document.getElementById('ai-input-area').classList.remove('hidden');
        }

        async function sendFollowUp() {
            const input = document.getElementById('follow-up-input');
            const text = input.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            input.value = ''; 
            
            const container = document.getElementById('ai-chat-container');
            const loaderDiv = document.createElement('div');
            loaderDiv.id = "temp-loader";
            loaderDiv.innerHTML = `<div class="flex items-center gap-2 p-4 text-stone-400 italic text-sm"><div class="ai-spinner w-4 h-4"></div> Der Historiker denkt nach...</div>`;
            container.appendChild(loaderDiv);
            container.scrollTop = container.scrollHeight;

            chatContext.push({ role: 'user', parts: [{ text: text }] });

            const result = await callGeminiWithHistory(chatContext);
            
            document.getElementById('temp-loader').remove();
            appendMessage(result, 'ai');
            
            chatContext.push({ role: 'model', parts: [{ text: result }] });
        }

        async function callGeminiWithHistory(contentsArray) {
            const key = getApiKey();
            if (!key) return "FEHLER: Kein API-Key.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            
            try {
                const response = await fetch(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ contents: contentsArray })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    if(response.status === 403) return `<b>API Fehler (403):</b> Key abgelehnt.`;
                    return `<b>API Fehler:</b> ${err.error?.message}`;
                }
                const data = await response.json(); 
                return data.candidates[0].content.parts[0].text;
            } catch (error) { return `<b>Netzwerkfehler:</b> ${error.message}`; }
        }
    </script>
</body>
</html>
