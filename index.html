import React, { useState, useEffect, useMemo, useRef } from 'react';
import { Play, Pause, Info, Map as MapIcon, Layers, BookOpen } from 'lucide-react';
import { MapContainer, TileLayer, Polyline, CircleMarker, Popup, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';

// Fix für fehlende Leaflet-Icons in React-Umgebungen
import L from 'leaflet';

// --- DATENSATZ: Historische Routen (Vereinfacht & Interpoliert) ---
// Struktur: [Lat, Lng, Jahr, Ortsname/Ereignis]
const MIGRATION_DATA = {
  westgoten: {
    name: "Westgoten",
    color: "#dc2626", // Rot
    description: "Von der Donau über Rom nach Aquitanien und Spanien.",
    path: [
      [45.0, 24.0, 375, "Dacia (Vor der Flucht)"],
      [41.6, 26.5, 378, "Schlacht von Adrianopel"],
      [40.6, 22.9, 395, "Aufstand unter Alarich"],
      [41.9, 12.5, 410, "Plünderung von Rom"],
      [43.6, 1.4, 418, "Ansiedlung in Tolosa (Aquitanien)"],
      [41.6, -4.7, 470, "Expansion nach Spanien"],
      [39.8, -4.0, 507, "Toledo (Zentrum des Reiches)"]
    ]
  },
  vandalen: {
    name: "Vandalen",
    color: "#2563eb", // Blau
    description: "Der lange Marsch: Rhein, Spanien, Nordafrika, Karthago.",
    path: [
      [50.0, 8.0, 400, "Siedlungsgebiet am Main"],
      [49.9, 8.2, 406, "Rheinübergang"],
      [45.0, 0.0, 409, "Durchzug durch Gallien"],
      [40.4, -3.7, 415, "Spanien (Andalusien)"],
      [35.9, -5.6, 429, "Überfahrt nach Afrika"],
      [36.8, 10.1, 439, "Eroberung von Karthago"],
      [41.9, 12.5, 455, "Plünderung von Rom (von See)"],
      [36.8, 10.1, 460, "Rückkehr nach Karthago"]
    ]
  },
  hunnen: {
    name: "Hunnen",
    color: "#16a34a", // Grün
    description: "Der Auslöser aus den Steppen. Vorstoß bis Gallien.",
    path: [
      [48.0, 45.0, 370, "Volga-Don-Steppe"],
      [47.5, 19.0, 400, "Pannonien (Ungarn)"],
      [49.0, 4.0, 451, "Schlacht auf den Katalaunischen Feldern"],
      [45.4, 10.9, 452, "Zug nach Italien"],
      [47.5, 19.0, 453, "Tod Attilas & Rückzug"]
    ]
  },
  langobarden: {
    name: "Langobarden",
    color: "#d97706", // Orange
    description: "Die späten Ankömmlinge. Elbe, Pannonien, Italien.",
    path: [
      [53.5, 10.5, 380, "Unterlauf der Elbe"],
      [48.5, 16.5, 489, "Rugiland (Niederösterreich)"],
      [47.5, 19.0, 540, "Pannonien"],
      [45.4, 9.1, 568, "Eroberung der Lombardei"]
    ]
  }
};

// --- HELPER: Lineare Interpolation ---
// Berechnet die Position zwischen zwei Punkten basierend auf dem Jahr
const getPositionAtYear = (path, year) => {
  if (year < path[0][2]) return null; // Noch nicht gestartet
  if (year > path[path.length - 1][2]) return path[path.length - 1]; // Angekommen

  for (let i = 0; i < path.length - 1; i++) {
    const start = path[i];
    const end = path[i + 1];
    
    if (year >= start[2] && year <= end[2]) {
      const duration = end[2] - start[2];
      const elapsed = year - start[2];
      const ratio = elapsed / duration;

      const lat = start[0] + (end[0] - start[0]) * ratio;
      const lng = start[1] + (end[1] - start[1]) * ratio;
      
      return [lat, lng, year, "Unterwegs..."];
    }
  }
  return null;
};

// --- KOMPONENTEN ---

// Custom Map Controller um Zoom zu setzen wenn nötig
const MapController = () => {
  const map = useMap();
  // Optional: Man könnte hier auf Events reagieren
  return null;
};

const Legend = ({ data, activeGroups, toggleGroup }) => (
  <div className="bg-white/90 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-stone-200 text-sm max-w-xs">
    <h3 className="font-serif font-bold text-stone-800 mb-2 border-b border-stone-300 pb-1">Völker & Stämme</h3>
    <div className="space-y-2">
      {Object.entries(data).map(([key, group]) => (
        <div 
          key={key} 
          onClick={() => toggleGroup(key)}
          className={`flex items-center cursor-pointer transition-opacity ${activeGroups[key] ? 'opacity-100' : 'opacity-50'}`}
        >
          <div className="w-4 h-4 rounded-full mr-2 shadow-sm" style={{ backgroundColor: group.color }}></div>
          <span className="font-medium text-stone-700">{group.name}</span>
        </div>
      ))}
    </div>
  </div>
);

export default function MigrationApp() {
  // State
  const [year, setYear] = useState(370);
  const [isPlaying, setIsPlaying] = useState(false);
  const [speed, setSpeed] = useState(1);
  const [activeGroups, setActiveGroups] = useState({
    westgoten: true,
    vandalen: true,
    hunnen: true,
    langobarden: true
  });
  const [selectedInfo, setSelectedInfo] = useState(null);

  // Animation Loop
  useEffect(() => {
    let interval;
    if (isPlaying) {
      interval = setInterval(() => {
        setYear(prev => {
          if (prev >= 570) {
            setIsPlaying(false);
            return 570;
          }
          return prev + 1;
        });
      }, 200 / speed); // Geschwindigkeit anpassen
    }
    return () => clearInterval(interval);
  }, [isPlaying, speed]);

  // Berechnete Positionen für das aktuelle Jahr
  const currentPositions = useMemo(() => {
    const positions = {};
    Object.entries(MIGRATION_DATA).forEach(([key, group]) => {
      if (!activeGroups[key]) return;
      
      const pos = getPositionAtYear(group.path, year);
      if (pos) {
        // Finde den Pfad bis zum aktuellen Jahr für die "Spur"
        const pastPath = group.path.filter(p => p[2] <= year).map(p => [p[0], p[1]]);
        // Füge aktuelle interpolierte Position hinzu
        pastPath.push([pos[0], pos[1]]);
        
        positions[key] = {
          current: pos,
          trail: pastPath,
          color: group.color,
          name: group.name,
          info: group.description
        };
      }
    });
    return positions;
  }, [year, activeGroups]);

  const toggleGroup = (key) => {
    setActiveGroups(prev => ({...prev, [key]: !prev[key]}));
  };

  return (
    <div className="flex flex-col h-screen bg-stone-100 font-sans text-stone-900 overflow-hidden">
      
      {/* HEADER - Mobile Friendly */}
      <header className="bg-stone-900 text-stone-50 p-3 shadow-md flex justify-between items-center z-20">
        <div className="flex items-center gap-2">
          <MapIcon size={20} className="text-amber-500" />
          <h1 className="font-serif text-lg font-bold tracking-wide">Völkerwanderung</h1>
        </div>
        <div className="text-xs text-stone-400 bg-stone-800 px-2 py-1 rounded">
          ca. 375 – 568 n. Chr.
        </div>
      </header>

      {/* MAIN MAP AREA */}
      <div className="flex-1 relative z-10">
        <MapContainer 
          center={[47.0, 12.0]} 
          zoom={4} 
          style={{ height: '100%', width: '100%', background: '#f5f5f4' }}
          zoomControl={false}
          attributionControl={false}
        >
          {/* Eine schlichte, "historisch" wirkende Karte (Standard OSM mit Filter wäre Option, hier CartoDB Voyager für Klarheit) */}
          <TileLayer
            url="https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png"
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          />
          
          {/* Römische Labels (Manuell/Statisch zur Orientierung) */}
          <CircleMarker center={[41.9, 12.5]} radius={2} pathOptions={{color: 'black', fillOpacity: 1}}>
             <Popup>Rom</Popup>
          </CircleMarker>
          <CircleMarker center={[41.0, 28.9]} radius={2} pathOptions={{color: 'black', fillOpacity: 1}}>
             <Popup>Konstantinopel</Popup>
          </CircleMarker>

          {/* Dynamische Layer */}
          {Object.entries(currentPositions).map(([key, data]) => (
            <React.Fragment key={key}>
              {/* Die Spur (Vergangenheit) */}
              <Polyline 
                positions={data.trail} 
                pathOptions={{ color: data.color, weight: 3, opacity: 0.6, dashArray: '5, 10' }} 
              />
              
              {/* Die aktuelle Position (Kopf) */}
              <CircleMarker 
                center={[data.current[0], data.current[1]]} 
                radius={6} 
                pathOptions={{ color: 'white', fillColor: data.color, fillOpacity: 1, weight: 2 }}
                eventHandlers={{
                  click: () => setSelectedInfo({ name: data.name, desc: data.info, year: year })
                }}
              >
                 <Popup className="font-serif">
                    <strong>{data.name}</strong><br/>
                    <span className="text-xs text-gray-600">Jahr: {Math.floor(year)}</span>
                 </Popup>
              </CircleMarker>
            </React.Fragment>
          ))}

          <MapController />
        </MapContainer>

        {/* Legend Overlay (Desktop: Top Right, Mobile: Hidden/Bottom toggle usually, keeping simplistic here) */}
        <div className="absolute top-4 right-4 z-[1000] hidden md:block">
          <Legend data={MIGRATION_DATA} activeGroups={activeGroups} toggleGroup={toggleGroup} />
        </div>

        {/* Event Overlay / Info Box */}
        {selectedInfo && (
          <div className="absolute top-4 left-4 right-16 md:right-auto md:w-64 bg-white p-4 rounded shadow-xl border-l-4 border-amber-500 z-[1000] animate-fade-in">
            <div className="flex justify-between items-start">
              <h3 className="font-bold font-serif text-lg">{selectedInfo.name}</h3>
              <button onClick={() => setSelectedInfo(null)} className="text-stone-400 hover:text-stone-600">×</button>
            </div>
            <p className="text-sm text-stone-600 mt-1 leading-relaxed">{selectedInfo.desc}</p>
          </div>
        )}
      </div>

      {/* TIMELINE & CONTROLS (Bottom Sheet Style) */}
      <div className="bg-white border-t border-stone-200 p-4 pb-8 shadow-2xl z-30">
        
        <div className="flex flex-col gap-4 max-w-3xl mx-auto">
          
          {/* Year Display & Main Controls */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <button 
                onClick={() => setIsPlaying(!isPlaying)}
                className={`w-12 h-12 rounded-full flex items-center justify-center text-white shadow-md transition-colors ${isPlaying ? 'bg-stone-600 hover:bg-stone-700' : 'bg-amber-600 hover:bg-amber-700'}`}
              >
                {isPlaying ? <Pause size={20} /> : <Play size={20} className="ml-1" />}
              </button>
              <div>
                <div className="text-xs uppercase tracking-wider text-stone-500 font-bold">Aktuelles Jahr</div>
                <div className="text-3xl font-serif font-bold text-stone-800">{Math.floor(year)} <span className="text-base font-normal text-stone-500">n. Chr.</span></div>
              </div>
            </div>

            {/* Speed Control (Desktop mainly) */}
            <div className="hidden md:flex items-center gap-2 bg-stone-100 px-3 py-1 rounded-full">
              <span className="text-xs font-bold text-stone-500">Tempo</span>
              <input 
                type="range" 
                min="0.5" 
                max="3" 
                step="0.5" 
                value={speed} 
                onChange={(e) => setSpeed(parseFloat(e.target.value))}
                className="w-20 accent-stone-600"
              />
            </div>
          </div>

          {/* Timeline Slider */}
          <div className="relative pt-2">
            <input 
              type="range" 
              min="370" 
              max="570" 
              value={year} 
              onChange={(e) => {
                setYear(parseInt(e.target.value));
                setIsPlaying(false); // Stop on manual interaction
              }}
              className="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-amber-600"
            />
            {/* Timeline Markers */}
            <div className="flex justify-between text-xs text-stone-400 mt-1 font-mono">
              <span>370</span>
              <span>400</span>
              <span>450</span>
              <span>500</span>
              <span>550+</span>
            </div>
            
            {/* Historical Milestones (Visual Hints on slider) */}
            <div className="absolute top-0 left-0 w-full h-2 pointer-events-none">
              {/* Adrianopel 378 ~4% */}
              <div className="absolute left-[4%] top-3 w-0.5 h-2 bg-stone-300"></div>
              {/* Rom Plünderung 410 ~20% */}
              <div className="absolute left-[20%] top-3 w-0.5 h-2 bg-red-300"></div>
              {/* Ende Westrom 476 ~53% */}
              <div className="absolute left-[53%] top-3 w-0.5 h-2 bg-stone-800"></div>
            </div>
          </div>

          {/* Mobile Legend Toggle / Simple List */}
          <div className="md:hidden flex flex-wrap gap-2 mt-2">
             {Object.entries(MIGRATION_DATA).map(([key, group]) => (
                <button 
                  key={key}
                  onClick={() => toggleGroup(key)}
                  className={`px-2 py-1 rounded-full text-xs border font-medium flex items-center gap-1 transition-colors ${
                    activeGroups[key] 
                    ? 'bg-stone-100 border-stone-300 text-stone-800' 
                    : 'bg-white border-stone-100 text-stone-300'
                  }`}
                >
                  <div className="w-2 h-2 rounded-full" style={{ backgroundColor: group.color }}></div>
                  {group.name}
                </button>
             ))}
          </div>

        </div>
      </div>
      
      <style jsx global>{`
        .leaflet-container {
          background: #f5f5f4;
          font-family: 'Noto Sans', sans-serif;
        }
        /* Custom Scrollbar for webkit */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 3px;
        }
      `}</style>
    </div>
  );
}
